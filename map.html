<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¥ è¨ºæ‰€åœ°åœ– - å°åŒ—å¸‚</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol/ol.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/0.0.124/turf.min.js"></script>

    <style>
        
        body {
            font-family: Arial, sans-serif;
            /*å­—é«”é¡è‰²è—è‰²*/
            background-color: rgb(6, 6, 10);

        }
        #map {
            width: 100%;
            height: 80vh;
        }
        .layer-control {
            position: absolute;
            top: 50px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .layer-control label {
            display: block;
        }
        .ol-popup {
            position: absolute;
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ccc;
            bottom: 12px;
            left: -50px;
            min-width: 200px;
        }
        .ol-popup:after, .ol-popup:before {
            top: 100%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
        }
        .ol-popup:after {
            border-color: rgba(255, 255, 255, 0);
            border-top-color: white;
            border-width: 10px;
            left: 48px;
            margin-left: -10px;
        }
        .ol-popup:before {
            border-color: rgba(204, 204, 204, 0);
            border-top-color: #ccc;
            border-width: 11px;
            left: 48px;
            margin-left: -11px;
        }
        .ol-popup-closer {
            text-decoration: none;
            position: absolute;
            top: 2px;
            right: 8px;
        }
        .ol-popup-closer:after {
            content: "âœ–";
        }
    </style>
</head>
<body>
    <h2 class="text-center my-4" style="color: rgb(255, 255, 255);">ğŸ¥ å°åŒ—å¸‚è¨ºæ‰€åœ°åœ–</h2>
    <div id="map"></div>
    <div class="layer-control mt-5">
    <h4 data-bs-toggle="collapse" href="#collapseBasemap" role="button" aria-expanded="false" aria-controls="collapseBasemap">ğŸ—ºï¸ åº•åœ–é¸æ“‡</h4>

    <div class="collapse my-2" id="collapseBasemap">
            <label><input type="radio" name="baseLayer" value="osm-standard" checked> OpenStreetMap æ¨™æº–</label>
            <label><input type="radio" name="baseLayer" value="stamen-toner"> Stamen Toner</label>
            <label><input type="radio" name="baseLayer" value="stamen-terrain"> Stamen Terrain</label>
            <label><input type="radio" name="baseLayer" value="cartodb-positron"> CartoDB Positron</label>
    </div>

    <h4 data-bs-toggle="collapse" href="#collapseDistrict" role="button" aria-expanded="false" aria-controls="collapseDistrict">ğŸ©º è¡Œæ”¿å€è¨ºæ‰€è³‡æ–™</h4>
    <div class="collapse my-2" id="collapseDistrict">
        <label><input type="checkbox" class="district-toggle" data-district="ä¸­æ­£å€" checked> ä¸­æ­£å€<span class="clinic-count"></span></label>

        <label><input type="checkbox" class="district-toggle" data-district="å¤§åŒå€" checked> å¤§åŒå€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="ä¸­å±±å€" checked> ä¸­å±±å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="æ¾å±±å€" checked> æ¾å±±å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="å¤§å®‰å€" checked> å¤§å®‰å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="è¬è¯å€" checked> è¬è¯å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="ä¿¡ç¾©å€" checked> ä¿¡ç¾©å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="å£«æ—å€" checked> å£«æ—å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="åŒ—æŠ•å€" checked> åŒ—æŠ•å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="å…§æ¹–å€" checked> å…§æ¹–å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="å—æ¸¯å€" checked> å—æ¸¯å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="æ–‡å±±å€" checked> æ–‡å±±å€<span class="clinic-count"></span></label>
        
    
        
        <!-- æ ¹æ“šå¯¦éš›è¡Œæ”¿å€åç¨±ç”Ÿæˆé¸æ“‡æ¡† -->
 
        <!-- æ·»åŠ å…¶ä»–è¡Œæ”¿å€ -->
    </div>

    <h4 data-bs-toggle="collapse" href="#collapseLayer" role="button" aria-expanded="false" aria-controls="collapseLayer">ğŸ“Œ åœ–è³‡</h4>

    <div class="collapse my-2" id="collapseLayer">
            <label><input type="checkbox" class="data-toggle" data-dataset="average-income"> æ‰€å¾—å¹³å‡æ•¸<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="data-toggle" data-dataset="median-income"> æ‰€å¾—ä¸­ä½æ•¸<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="data-toggle" data-dataset="population"> äººå£æ•¸<span class="clinic-count"></span></label>
            <label>âœ¨æ›´å¤šåœ–è³‡æº–å‚™ä¸­âœ¨</label>
    </div>

    </div>
    <!-- Popup HTML -->
    <div id="popup" class="ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content"></div>
    </div>

    <script>
        // é è¨­å°åŒ—å¸‚çš„ä¸­å¿ƒåº§æ¨™ (ç¶“åº¦, ç·¯åº¦)
        var taipeiCenter = [121.5654, 25.0330]; // å°åŒ—å¸‚ä¿¡ç¾©å€ç¶“ç·¯åº¦
        taipeiCenter = ol.proj.fromLonLat(taipeiCenter); // è½‰æ›ç¶“ç·¯åº¦ç‚ºåœ°åœ–æŠ•å½±åº§æ¨™

  // å»ºç«‹åœ°åœ–åœ–å±¤
  var map = new ol.Map({
    target: 'map',
    layers: [
    
        new ol.layer.Tile({
            source: new ol.source.OSM(), // OpenStreetMap æ¨™æº–
            title: 'osm-standard'
        }),
        new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://tiles.stadiamaps.com/tiles/stamen_toner/{z}/{x}/{y}@2x.png'
            }),
            title: 'stamen-toner',
            visible: false
        }),
        new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://tiles.stadiamaps.com/tiles/stamen_terrain/{z}/{x}/{y}@2x.png'
            }),
            title: 'stamen-terrain',
            visible: false
        }),
        new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://{a-c}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png'
            }),
            title: 'cartodb-positron',
            visible: false
        })
    ],
    view: new ol.View({
        center: taipeiCenter,
        zoom: 12 // é è¨­ç¸®æ”¾æ¯”ä¾‹
    })
});

// åœ–å±¤åˆ‡æ›åŠŸèƒ½
document.querySelectorAll('input[name="baseLayer"]').forEach(function(element) {
    element.addEventListener('change', function() {
        var selectedLayer = this.value;
        map.getLayers().forEach(function(layer) {
            // åªåˆ‡æ›åº•åœ–åœ–å±¤çš„é¡¯ç¤ºç‹€æ…‹
            if (layer instanceof ol.layer.Tile) {
                layer.setVisible(layer.get('title') === selectedLayer);
            }
        });
    });
});


// æ·»åŠ  tpe_income.geojson ä½œç‚ºå€åŸŸåœ–å±¤
var incomeLayer = new ol.layer.Vector({
    source: new ol.source.Vector({
        url: 'tpe_income.geojson', // æ›¿æ›ç‚ºå¯¦éš›æª”æ¡ˆè·¯å¾‘
        format: new ol.format.GeoJSON()
    }),
    style: new ol.style.Style({
        stroke: new ol.style.Stroke({
            color: '#319FD3',
            width: 2
        }),
        fill: new ol.style.Fill({
            color: 'rgba(0, 255, 255, 0.1)'
        })
    })
});
map.addLayer(incomeLayer);

// è¨ºæ‰€è³‡æ–™åœ–å±¤ï¼ˆä¿æŒç¨ç«‹ï¼‰
var vectorSources = {}; // å„²å­˜å„è¡Œæ”¿å€çš„è³‡æ–™ä¾†æº
var vectorLayers = {}; // å„²å­˜å„è¡Œæ”¿å€çš„è¨ºæ‰€åœ–å±¤
fetch('å°åŒ—å¸‚è¨ºæ‰€ï¼¿ç¶“ç·¯åº¦.csv')
    .then(response => response.text())
    .then(csvText => {
        Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                let districtCounts = {}; // å„²å­˜æ¯å€‹è¡Œæ”¿å€çš„è¨ºæ‰€æ•¸é‡

                results.data.forEach(row => {
                    let name = row['æ©Ÿæ§‹åç¨±'];
                    let phone = row['é›»è©±'];
                    let address = row['åœ°å€'];
                    let latitude = parseFloat(row['ç·¯åº¦']);
                    let longitude = parseFloat(row['ç¶“åº¦']);
                    let district = row['å€å'];

                    if (!isNaN(latitude) && !isNaN(longitude)) {
                        let coordinates = ol.proj.fromLonLat([longitude, latitude]);

                        if (!vectorSources[district]) {
                            vectorSources[district] = new ol.source.Vector();
                            vectorLayers[district] = new ol.layer.Vector({
                                source: vectorSources[district],
                                visible: true,
                                title: district
                            });
                            map.addLayer(vectorLayers[district]);
                        }

                        let marker = new ol.Feature({
                            geometry: new ol.geom.Point(coordinates),
                            name: name,
                            phone: phone,
                            address: address
                        });

                        marker.setStyle(new ol.style.Style({
                            image: new ol.style.Circle({
                                radius: 6,
                                fill: new ol.style.Fill({
                                    color: 'red'
                                }),
                                stroke: new ol.style.Stroke({
                                    color: 'white',
                                    width: 2
                                })
                            })
                        }));

                        vectorSources[district].addFeature(marker);

                        // è¨ˆç®—æ¯å€‹è¡Œæ”¿å€çš„è¨ºæ‰€æ•¸é‡
                        if (!districtCounts[district]) {
                            districtCounts[district] = 0;
                        }
                        districtCounts[district]++;
                    }
                });

                // æ›´æ–°è¡Œæ”¿å€é¸æ“‡æ¡†ä¸­çš„è¨ºæ‰€æ•¸é‡
                document.querySelectorAll('.district-toggle').forEach(function(element) {
                    let district = element.getAttribute('data-district');
                    if (districtCounts[district]) {
                        element.nextElementSibling.innerHTML = //district+ 
                        ' (' + districtCounts[district] + 'é–“è¨ºæ‰€)';
                    }
                });

                // æ ¹æ“šé¸æ“‡é¡¯ç¤ºæˆ–éš±è—è¡Œæ”¿å€çš„è¨ºæ‰€
                document.querySelectorAll('.district-toggle').forEach(function(element) {
                    element.addEventListener('change', function() {
                        let district = this.getAttribute('data-district');
                        if (vectorLayers[district]) {
                            vectorLayers[district].setVisible(this.checked);
                        }
                    });
                });
            }
        });
    })
    .catch(error => {
        console.error('Error:', error);
    });

// å»ºç«‹ Overlay ä¾†é¡¯ç¤º popup
var popup = new ol.Overlay({
    element: document.getElementById('popup'),
    autoPan: false,

});
map.addOverlay(popup);

// é¡¯ç¤º popup çš„å…§å®¹
map.on('singleclick', function (evt) {
    var feature = map.forEachFeatureAtPixel(evt.pixel, function (feature) {
        return feature;
    });

    if (feature) {
        var properties = feature.getProperties();
    
        // åˆ¤æ–·æ˜¯å¦æ˜¯è¨ºæ‰€
        if (properties.name && properties.phone && properties.address) {
            // è¨ºæ‰€çš„ popup
            var coordinates = feature.getGeometry().getCoordinates();
            popup.setPosition(coordinates);
    
            var content = '<b>' + feature.get('name') + '</b><br>' +
                          'é›»è©±: ' + feature.get('phone') + '<br>' +
                          'åœ°å€: ' + feature.get('address');
    
            document.getElementById('popup-content').innerHTML = content;
            document.getElementById('popup').style.display = 'block';
        } else {
            // å¦‚æœæ˜¯ GeoJSON å€åŸŸ
            var geometry = feature.getGeometry();
            coordinates = ol.extent.getCenter(geometry.getExtent());

            // è¨ˆç®—è©²å€åŸŸå…§çš„è¨ºæ‰€æ•¸é‡
            var clinicCount = 0;
            for (var district in vectorSources) {
                vectorSources[district].getFeatures().forEach(function(clinicFeature) {
                    var clinicCoords = clinicFeature.getGeometry().getCoordinates();
                    if (geometry.intersectsCoordinate(clinicCoords)) {
                        clinicCount++;
                    }
                });
            }

            // é¡¯ç¤ºå€åŸŸå…§è¨ºæ‰€æ•¸é‡å’Œå…¶ä»–å€åŸŸå±¬æ€§
            var population = properties['POPULATION'] || 0;
            var maleToFemaleRatio = (properties['äººå£æ•¸_å¥³'] !== 0) ? 
                (properties['äººå£æ•¸_ç”·'] / properties['äººå£æ•¸_å¥³']).toFixed(2) : 'N/A';
            
            popup.setPosition(coordinates);
    
            var content = '<b>é¸å®šå€åŸŸè³‡æ–™:</b><br>' +
                          properties['VILLAGE'] + '<br>' +
                          '<b>äººå£æ•¸:</b> ' + properties['äººå£æ•¸_äººå£æ•¸'] + '<br>' +
                          '<b>æ‰€å¾—å¹³å‡æ•¸:</b> ' + Math.round(properties['2022å°ç£æ‰€å¾—data_å¹³å‡æ•¸'] / 10) + 'è¬<br>' +
                          '<b>æ‰€å¾—ä¸­ä½æ•¸:</b> ' + Math.round(properties['2022å°ç£æ‰€å¾—data_ä¸­ä½æ•¸'] / 10) + 'è¬<br>' +
                          '<b>ç”·å¥³æ¯”ä¾‹:</b> ' + maleToFemaleRatio + '<br>' +
                          '<b>è¨ºæ‰€æ•¸é‡:</b> ' + clinicCount + ' é–“è¨ºæ‰€'+ '<br>' +
                          '<b>ä¸€é–“è¨ºæ‰€æœå‹™</b> ' + Math.round(properties['äººå£æ•¸_äººå£æ•¸']/clinicCount) + 'äºº';
    
            document.getElementById('popup-content').innerHTML = content;
            document.getElementById('popup').style.display = 'block';
        }
    } else {
        document.getElementById('popup').style.display = 'none';
    }
});

    </script>

    <script>
    //æ›´æ–°åœ°åœ–æ¨£å¼
 // æ ¹æ“šä¸åŒçš„æ•¸æ“šè¨­å®šæ¨£å¼
function getStyleByDataset(feature, dataset) {
    let value, ranges, colors;

    // æ ¹æ“š dataset è¨­å®šä¸åŒçš„ç´šè·ç¯„åœèˆ‡å°æ‡‰é¡è‰²
    if (dataset === 'average-income') {
        value = feature.get('2022å°ç£æ‰€å¾—data_å¹³å‡æ•¸');
        ranges = [500, 1000, 1500, 2000]; // ä¾‹å¦‚æ‰€å¾—å¹³å‡æ•¸çš„ç´šè·
        colors = [
            'rgba(255, 235, 190, 0.6)',
            'rgba(255, 204, 128, 0.6)',
            'rgba(255, 153, 85, 0.6)',
            'rgba(255, 77, 77, 0.6)'
        ];
    } else if (dataset === 'median-income') {
        value = feature.get('2022å°ç£æ‰€å¾—data_ä¸­ä½æ•¸');
        ranges = [300, 600, 900, 1200]; // ä¾‹å¦‚æ‰€å¾—ä¸­ä½æ•¸çš„ç´šè·
        colors = [
            'rgba(230, 245, 208, 0.6)',
            'rgba(170, 220, 130, 0.6)',
            'rgba(110, 200, 80, 0.6)',
            'rgba(50, 150, 30, 0.6)'
        ];
    } else if (dataset === 'population') {
        value = feature.get('äººå£æ•¸_äººå£æ•¸');
        ranges = [1000, 3000, 5000, 10000]; // ä¾‹å¦‚äººå£æ•¸çš„ç´šè·
        colors = [
            'rgba(190, 235, 255, 0.6)',
            'rgba(128, 204, 255, 0.6)',
            'rgba(85, 153, 255, 0.6)',
            'rgba(77, 77, 255, 0.6)'
        ];
    }

    // æ ¹æ“šç´šè·è¨­å®šé¡è‰²
    let color = getColorForValue(value, ranges, colors);

    return new ol.style.Style({
        fill: new ol.style.Fill({
            color: color
        }),
        stroke: new ol.style.Stroke({
            color: '#333',
            width: 1
        })
    });
}

// æ ¹æ“š value è½åœ¨å“ªå€‹ç¯„åœä¾†é¸æ“‡å°æ‡‰çš„é¡è‰²
function getColorForValue(value, ranges, colors) {
    for (let i = 0; i < ranges.length; i++) {
        if (value < ranges[i]) {
            return colors[i];
        }
    }
    // è‹¥è¶…éæœ€å¤§ç¯„åœï¼Œä½¿ç”¨æœ€å¾Œä¸€å€‹é¡è‰²
    return colors[colors.length - 1];
}
    // æ›´æ–°åœ–å±¤æ¨£å¼çš„å‡½å¼
    function updateLayerStyle(dataset) {
        incomeLayer.setStyle(function(feature) {
            return getStyleByDataset(feature, dataset);
        });
    }

// ç•¶ä½¿ç”¨è€…å‹¾é¸ä¸åŒçš„æ•¸æ“šæ™‚è§¸ç™¼
document.querySelectorAll('.data-toggle').forEach(function(element) {
    element.addEventListener('change', function() {
        // å–æ¶ˆå…¶ä»–å‹¾é¸æ¡†çš„é¸æ“‡
        document.querySelectorAll('.data-toggle').forEach(function(el) {
            if (el !== element) {
                el.checked = false;
            }
        });

        // å–å¾—ç›®å‰é¸ä¸­çš„ dataset
        let dataset = this.getAttribute('data-dataset');

        // æ›´æ–°åœ–å±¤
        updateLayerStyle(dataset);
    });
});
    
    </script>
</body>
</html>
