<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🏥 診所地圖 - 新北市</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol/ol.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/0.0.124/turf.min.js"></script>

    <style>
        
        body {
            font-family: Arial, sans-serif;
            /*字體顏色藍色*/
            background-color: rgb(6, 6, 10);

        }
        #map {
            width: 100%;
            height: 80vh;
        }
        .layer-control {
            position: absolute;
            top: 50px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .layer-control label {
            display: block;
        }
        .ol-popup {
            position: absolute;
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ccc;
            bottom: 12px;
            left: -50px;
            min-width: 200px;
        }
        .ol-popup:after, .ol-popup:before {
            top: 100%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
        }
        .ol-popup:after {
            border-color: rgba(255, 255, 255, 0);
            border-top-color: white;
            border-width: 10px;
            left: 48px;
            margin-left: -10px;
        }
        .ol-popup:before {
            border-color: rgba(204, 204, 204, 0);
            border-top-color: #ccc;
            border-width: 11px;
            left: 48px;
            margin-left: -11px;
        }
        .ol-popup-closer {
            text-decoration: none;
            position: absolute;
            top: 2px;
            right: 8px;
        }
        .ol-popup-closer:after {
            content: "✖";
        }

        .search-container {
            position: absolute;  /* 讓搜尋框漂浮在地圖上 */
            top: 100px;          /* 垂直位置 */
            left: 50%;          /* 水平置中 */
            transform: translateX(-50%); /* 水平置中 */
            z-index: 1000;     /* 確保搜尋框在地圖之上 */
        }
        
        .search-input {
            font-size: 1.2rem;  /* 字體大小 */
            border-radius: 2rem; /* 圓角 */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); /* 輕微陰影 */
        }
        
    </style>
</head>
<body>
    <h2 class="text-center my-4" style="color: rgb(255, 255, 255);">🏥 新北市診所地圖</h2>
    <div id="map"></div>
    <div class="layer-control mt-5">
    <h4 data-bs-toggle="collapse" href="#collapseBasemap" role="button" aria-expanded="false" aria-controls="collapseBasemap">🗺️ 底圖選擇</h4>

    <div class="collapse my-2" id="collapseBasemap">
        <label><input type="radio" name="baseLayer" value="osm-standard"> OpenStreetMap 標準</label>
        <label><input type="radio" name="baseLayer" value="cartodb-dark"> CartoDB Dark Matter</label>
        <label><input type="radio" name="baseLayer" value="google-satellite"> Google 衛星</label>
        <label><input type="radio" name="baseLayer" value="cartodb-positron" checked> CartoDB Positron</label>
        
    </div>

    <h4 data-bs-toggle="collapse" href="#collapseDistrict" role="button" aria-expanded="false" aria-controls="collapseDistrict">🩺 行政區診所資料</h4>
    <div class="collapse my-2" id="collapseDistrict" style="max-height: 300px; overflow-y: auto;">
        <label><input type="checkbox" class="district-toggle" data-district="板橋區" > 板橋區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="新莊區" > 新莊區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="中和區" > 中和區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="永和區" > 永和區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="土城區" > 土城區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="三重區" > 三重區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="蘆洲區" > 蘆洲區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="五股區" > 五股區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="泰山區" > 泰山區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="林口區" > 林口區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="三峽區" > 三峽區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="樹林區" > 樹林區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="鶯歌區" > 鶯歌區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="淡水區" > 淡水區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="八里區" > 八里區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="三芝區" > 三芝區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="石門區" > 石門區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="金山區" > 金山區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="萬里區" > 萬里區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="汐止區" > 汐止區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="瑞芳區" > 瑞芳區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="平溪區" > 平溪區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="雙溪區" > 雙溪區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="貢寮區" > 貢寮區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="深坑區" > 深坑區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="石碇區" > 石碇區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="新店區" > 新店區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="坪林區" > 坪林區<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="烏來區" > 烏來區<span class="clinic-count"></span></label>
        
        
    
        
        <!-- 根據實際行政區名稱生成選擇框 -->
 
        <!-- 添加其他行政區 -->
    </div>

    <h4 data-bs-toggle="collapse" href="#collapseLayer" role="button" aria-expanded="false" aria-controls="collapseLayer">📌 圖資</h4>

    <div class="collapse my-2" id="collapseLayer">
            <label><input type="checkbox" class="data-toggle" data-dataset="average-income"> 所得平均數<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="data-toggle" data-dataset="median-income"> 所得中位數<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="data-toggle" data-dataset="population"> 人口數<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="data-toggle" data-dataset="none"> 關閉<span class="clinic-count"></span></label>
            <label>✨更多圖資準備中✨</label>
    </div>

    <h4 data-bs-toggle="collapse" href="#collapseSpecialty" role="button" aria-expanded="false" aria-controls="collapseSpecialty">➕ 科別</h4>

    <div class="collapse my-2" id="collapseSpecialty" style="max-height: 300px; overflow-y: auto;">
        <div>
            <input type="checkbox" id="select-all-specialties" checked> 全選/全不選
        </div>
        <div id="specialty-container"></div>
    </div>
    </div>
    <!-- Popup HTML -->
    <div id="popup" class="ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content"></div>
    </div>
    <!-- Hover顯示里的名稱 -->
    <div id="info" style="position: absolute; background: white; padding: 5px; border: 1px solid black; display: none;"></div>
    <!-- 診所資料查詢 -->
    <div class="search-container">
        <input type="text" id="clinic-search" list="clinic-list" placeholder="搜尋診所..." class="form-control search-input">
        <datalist id="clinic-list"></datalist>
    </div>
    
    <script>

        // 預設台北市的中心座標 (經度, 緯度)
        var taipeiCenter = [121.5654, 25.0330]; // 台北市信義區經緯度
        taipeiCenter = ol.proj.fromLonLat(taipeiCenter); // 轉換經緯度為地圖投影座標

  // 建立地圖圖層
 // 建立地圖圖層
var map = new ol.Map({
    target: 'map',
    layers: [
        new ol.layer.Tile({
            source: new ol.source.OSM(), // OpenStreetMap 標準
            title: 'osm-standard',
            visible: false
        }),
        new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://{a-c}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png' // CartoDB Dark Matter
            }),
            title: 'cartodb-dark',
            visible: false
        }),
        new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}' // Google 衛星圖層
            }),
            title: 'google-satellite',
            visible: false
        }),
        new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://{a-c}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png' // CartoDB Light
            }),
            title: 'cartodb-positron',
            visible: true
        })
    ],
    view: new ol.View({
        center: taipeiCenter,
        zoom: 12 // 預設縮放比例
    })
});


// 圖層切換功能
document.querySelectorAll('input[name="baseLayer"]').forEach(function(element) {
    element.addEventListener('change', function() {
        var selectedLayer = this.value;
        map.getLayers().forEach(function(layer) {
            // 只切換底圖圖層的顯示狀態
            if (layer instanceof ol.layer.Tile) {
                layer.setVisible(layer.get('title') === selectedLayer);
            }
        });
    });
});


// 添加 tpe_income.geojson 作為區域圖層
var incomeLayer = new ol.layer.Vector({
    source: new ol.source.Vector({
        url: 'newtpe_income.geojson', // 替換為實際檔案路徑
        format: new ol.format.GeoJSON()
    }),
    style: new ol.style.Style({
        stroke: new ol.style.Stroke({
            color: '#319FD3',
            width: 2
        }),
        fill: new ol.style.Fill({
            color: 'rgba(0, 255, 255, 0.1)'
        })
    })
});
map.addLayer(incomeLayer);

/// 隨機生成顏色的函數
function getRandomColor() {
    const letters = '0123456789ABCDEF';
    let color = '#';
    for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
}
// 定義50種鮮艷顏色的數組
const vibrantColors = [
    '#FF5733', // 鮮紅
    '#FF8C00', // 橘色
    '#FFD700', // 金色
    '#32CD32', // 翠綠色
    '#4682B4', // 鋼藍色
    '#6A5ACD', // 杜鵑紫
    '#FF69B4', // 粉紅色
    '#CD5C5C', // 印度紅
    '#20B2AA', // 淡海洋綠
    '#FF4500', // 橙紅色
    '#8B008B', // 深紫紅色
    '#7FFF00', // 查特留斯綠
    '#FFA07A', // 淺鮭紅
    '#FF6347', // 番茄色
    '#FFDAB9', // 桃色
    '#98FB98', // 淺綠色
    '#FF1493', // 深粉紅色
    '#FFB6C1', // 淺粉紅色
    '#AFEEEE', // 淺青色
    '#B22222', // 鮮紅色
    '#5F9EA0', // 醜藍
    '#4B0082', // 靛青色
    '#D2691E', // 巧克力色
    '#8FBC8F', // 深綠色
    '#FFD700', // 金黃色
    '#FFC0CB', // 粉紅色
    '#FF7F50', // 珊瑚色
    '#6495ED', // 玉米花藍
    '#3CB371', // 中海洋綠
    '#FF4500', // 橙紅色
    '#ADFF2F', // 草綠色
    '#7B68EE', // 濃藍色
    '#483D8B', // 深藍色
    '#2E8B57', // 海洋綠
    '#6B8E23', // 橄欖綠
    '#F0E68C', // 卡其色
    '#DDA0DD', // 鬱金香紫
    '#FF1493', // 深粉紅
    '#8B4513', // 駝色
    '#B8860B', // 金色
    '#D8BFD8', // 鬱金香紫
    '#E6E6FA', // 薰衣草紫
    '#DCDCDC', // 鉛灰色
    '#A0522D', // 鮮土色
    '#7B68EE', // 濃藍色
    '#F08080', // 淺紅色
    '#20B2AA', // 淡海洋綠
    '#FF6347', // 番茄色
    '#FFEFD5', // 魚肚白
    '#98FB98', // 淺綠色
    '#FFE4E1', // 莫蘭迪色
    '#FFB6C1', // 淺粉紅色
    '#ADD8E6', // 淺藍色
    '#F5F5DC', // 米色
    '#FAFAD2', // 淡金色
    '#DDA0DD'  // 鬱金香紫
];


// 診所資料圖層（保持獨立）
var vectorSources = {}; // 儲存各行政區的資料來源
var vectorLayers = {}; // 儲存各行政區的診所圖層
var specialtyColors = {}; // 儲存科別顏色的對應表
let colorIndex = 0; // 用來記錄當前顏色索引
let specialtySet = new Set();

fetch('新北市診所_經緯度.csv')
    .then(response => response.text())
    .then(csvText => {
        Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                let districtCounts = {}; // 儲存每個行政區的診所數量

                results.data.forEach(row => {
                    let name = row['機構名稱'];
                    let phone = row['電話'];
                    let address = row['地址'];
                    let district = row['區名'];
                    let doctor = row['A醫師'];
                    let TCM_doctor = row['B中醫師'];
                    let dentist = row['C牙醫師'];
                    let pharmacist = row['D藥師'];
                    let specialties = row['科別'] ? row['科別'].split(',').map(function(specialty) {
                        return specialty.trim();
                    }).filter(function(specialty) {
                        return specialty !== '';
                    }) : [];
                    let latitude = parseFloat(row['緯度']);
                    let longitude = parseFloat(row['經度']);


                    if (!isNaN(latitude) && !isNaN(longitude)) {
                        let coordinates = ol.proj.fromLonLat([longitude, latitude]);

                        if (!vectorSources[district]) {
                            vectorSources[district] = new ol.source.Vector();
                            vectorLayers[district] = new ol.layer.Vector({
                                source: vectorSources[district],
                                visible: false,
                                title: district
                            });
                            map.addLayer(vectorLayers[district]);
                        }

                        specialties.forEach(function(specialty) {
                            // 將科別添加到 Set 中
                            specialtySet.add(specialty);

                            // 如果這個科別還沒有顏色，則從固定顏色數組中選擇一個顏色
                            if (!specialtyColors[specialty]) {
                                specialtyColors[specialty] = vibrantColors[colorIndex % vibrantColors.length];
                                colorIndex++; // 更新顏色索引
                            }

                            let marker = new ol.Feature({
                                geometry: new ol.geom.Point(coordinates),
                                name: name,
                                phone: phone,
                                address: address,
                                doctor: doctor,
                                TCM_doctor: TCM_doctor,
                                dentist: dentist,
                                pharmacist: pharmacist,
                                specialties: specialty
                            });
                            // 使用分配的顏色
                            let fillColor = specialtyColors[specialty];
                            marker.setStyle(new ol.style.Style({
                                image: new ol.style.Circle({
                                    radius: 6,
                                    fill: new ol.style.Fill({
                                        color: fillColor
                                    }),
                                    stroke: new ol.style.Stroke({
                                        color: 'white',
                                        width: 1.5
                                    })
                                })
                            }));

                            vectorSources[district].addFeature(marker);
                        });
                        // 計算每個行政區的診所數量
                        if (!districtCounts[district]) {
                            districtCounts[district] = 0;
                        }
                        districtCounts[district]++;
                    }
                });

                // 動態生成科別的 HTML 欄位
                let specialtyContainer = document.getElementById('specialty-container');
                specialtySet.forEach(function(specialty) {
                    let label = document.createElement('label');

                    let checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'specialty-toggle';
                    checkbox.setAttribute('data-specialty', specialty);
                    checkbox.checked = true; // 設置為 checked

                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(' ' + specialty));
                    label.appendChild(document.createElement('span')).className = 'clinic-count';

                    specialtyContainer.appendChild(label);
                });

                // "全選/全不選" 的事件處理邏輯
                document.getElementById('select-all-specialties').addEventListener('change', function() {
                    let checkboxes = document.querySelectorAll('.specialty-toggle');
                    checkboxes.forEach(function(checkbox) {
                        checkbox.checked = document.getElementById('select-all-specialties').checked;
                        // 觸發每個 checkbox 的 change 事件以更新圖層顯示
                        checkbox.dispatchEvent(new Event('change'));
                    });
                });
                
                // 更新行政區選擇框中的診所數量
                document.querySelectorAll('.district-toggle').forEach(function(element) {
                    let district = element.getAttribute('data-district');
                    if (districtCounts[district]) {
                        element.nextElementSibling.innerHTML = 
                        district + ' (' + districtCounts[district] + '間診所)';
                    }
                });

                // 根據選擇顯示或隱藏行政區的診所
                document.querySelectorAll('.district-toggle').forEach(function(element) {
                    element.addEventListener('change', function() {
                        let district = this.getAttribute('data-district');
                        if (vectorLayers[district]) {
                            vectorLayers[district].setVisible(this.checked);
                        }
                    });
                });

                // 根據選擇顯示或隱藏特定科別的診所
                
                document.querySelectorAll('.specialty-toggle').forEach(function(element) {
                    element.addEventListener('change', function() {
                        let specialty = this.getAttribute('data-specialty');
                        let checked = this.checked;
                        for (let district in vectorSources) {
                            vectorSources[district].getFeatures().forEach(function(feature) {
                                if (feature.get('specialties').includes(specialty)) {
                                    feature.setStyle(new ol.style.Style({
                                        image: new ol.style.Circle({
                                            radius: 6,
                                            fill: new ol.style.Fill({
                                                color: checked ? specialtyColors[specialty] : 'rgba(0, 0, 0, 0)'
                                            }),
                                            stroke: new ol.style.Stroke({
                                                color: 'white',
                                                width: 1.5
                                            })
                                        })
                                    }));
                                }
                            });
                        }
                    });
                });



                
            }
        });
    })
    .catch(error => {
        console.error('Error:', error);
    });


//加入醫學中心，星形標記
fetch('醫學中心.csv')
    .then(response => response.text())
    .then(csvText => {
        Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                results.data.forEach(row => {
                    let name = row['機構名稱'];
                    let phone = row['電話'];
                    let address = row['地址'];
                    let latitude = parseFloat(row['緯度']);
                    let longitude = parseFloat(row['經度']);

                    let district = row['區名'];
                    let doctor = row['A醫師'];
                    let TCM_doctor = row['B中醫師'];
                    let dentist = row['C牙醫師'];
                    let pharmacist = row['D藥師'];
                    let specialties = ['醫學中心',];

                    if (!isNaN(latitude) && !isNaN(longitude)) {
                        let coordinates = ol.proj.fromLonLat([longitude, latitude]);

                        let marker = new ol.Feature({
                            geometry: new ol.geom.Point(coordinates),
                            geometry: new ol.geom.Point(coordinates),
                            name: name,
                            phone: phone,
                            address: address,
                            doctor: doctor,
                            TCM_doctor: TCM_doctor,
                            dentist: dentist,
                            pharmacist: pharmacist,
                            specialties: specialties
                        });
                        console.log(marker);
                        marker.setStyle(new ol.style.Style({
                            image: new ol.style.RegularShape({
                                fill: new ol.style.Fill({ color: 'rgba(255, 0, 0, 0.8)' }),
                                stroke: new ol.style.Stroke({ color: 'black', width: 1 }),
                                points: 5,
                                radius: 10,
                                radius2: 4,
                                angle: 0
                            })
                        }));

                        let vectorSource = new ol.source.Vector({
                            features: [marker]
                        });
                        let vectorLayer = new ol.layer.Vector({
                            source: vectorSource
                        });
                        map.addLayer(vectorLayer);
                    }
                });
            }
        });
    })
    .catch(error => {
        console.error('Error:', error);
    });
    



// 建立 Overlay 來顯示 popup
var popup = new ol.Overlay({
    element: document.getElementById('popup'),
    autoPan: false,

});


map.addOverlay(popup);

var closer = document.getElementById('popup-closer');

// Add click event listener to the closer element
closer.onclick = function() {
    console.log(document.getElementById('popup').style.display);
    document.getElementById('popup').style.display = 'none';
    infodisplay = 1;
    closer.blur();

    return false;
};


// 顯示 popup 的內容
map.on('singleclick', function (evt) {
    var feature = map.forEachFeatureAtPixel(evt.pixel, function (feature) {
        return feature;
    });

    if (feature) {
        var properties = feature.getProperties();
    
        // 判斷是否是診所
        if (properties.name && properties.phone && properties.address) {
            // 診所的 popup
            var coordinates = feature.getGeometry().getCoordinates();
            popup.setPosition(coordinates);
            var specialties = feature.get('specialties');
            console.log(specialties);
            var content = '<b>' + feature.get('name') + '</b><br>' +
            '☎️電話: ' + feature.get('phone') + '<br>' ;
            content+= '📓科別: '+feature.get('specialties');
            // Remove the last element from the list
            //specialties.pop(); 
            /*
            specialties.forEach(function(specialty) {
                content += '' + specialty + ' ';
            });
            */
            if (feature.get('doctor') !== '0') {
                content += '<br>💉醫師: ' + feature.get('doctor') + '位';
            }
            if (feature.get('TCM_doctor') !== '0') {
                content += '<br>🌿中醫師: ' + feature.get('TCM_doctor') + '位';
            }
            if (feature.get('dentist') !== '0') {
                content += '<br>🦷牙醫師: ' + feature.get('dentist') + '位';
            }
            if (feature.get('pharmacist') !== '0') {
                content += '<br>💊藥師: ' + feature.get('pharmacist') + '位';
            }
            content += '<br>地址: ' + feature.get('address');
    
        

            document.getElementById('popup-content').innerHTML = content;
            document.getElementById('popup').style.display = 'block';
            infodisplay = 0;
        } else {
            // 如果是 GeoJSON 區域
            var geometry = feature.getGeometry();
            coordinates = ol.extent.getCenter(geometry.getExtent());

            // 計算該區域內的診所數量
            var clinicCount = 0;
            for (var district in vectorSources) {
                vectorSources[district].getFeatures().forEach(function(clinicFeature) {
                    var clinicCoords = clinicFeature.getGeometry().getCoordinates();
                    if (geometry.intersectsCoordinate(clinicCoords)) {
                        clinicCount++;
                    }
                });
            }

            // 顯示區域內診所數量和其他區域屬性
            var population = properties['POPULATION'] || 0;
            var maleToFemaleRatio = (properties['113年8月新北市各里人口數排行榜_女'] !== 0) ? 
                (properties['113年8月新北市各里人口數排行榜_男'] / properties['113年8月新北市各里人口數排行榜_女']).toFixed(2) : 'N/A';
            
            popup.setPosition(coordinates);
    
            var content = '<b>🗺️' +
                          properties['VILLAGE'] + '<br>' +
                          '<hr>'+
                          '<b>🗿人口數:</b> ' + properties['113年8月新北市各里人口數排行榜_合計'] + '<br>' +
                          '<b>💰所得平均數:</b> ' + Math.round(properties['2022台灣所得data_平均數'] / 10) + '萬<br>' +
                          '<b>💰中位數:</b> ' + Math.round(properties['2022台灣所得data_中位數'] / 10) + '萬<br>' +
                          '<b>👫男女比例:</b> ' + maleToFemaleRatio + '<br>' +
                          '<b>🏥診所數量:</b> ' + clinicCount + ' 間診所'+ '<br>' +
                          '<b>一間診所服務</b> ' + (clinicCount > 0 ? Math.round(properties['113年8月新北市各里人口數排行榜_合計'] / clinicCount) + '人' : '無法計算');
    
            document.getElementById('popup-content').innerHTML = content;
            document.getElementById('popup').style.display = 'block';
            infodisplay = 0;
        }
    } else {
        document.getElementById('popup').style.display = 'none';
        infodisplay = 1;
    }
});

    </script>

    <script>
    //更新地圖樣式
 // 根據不同的數據設定樣式
function getStyleByDataset(feature, dataset) {
    let value, ranges, colors;

    // 根據 dataset 設定不同的級距範圍與對應顏色
    if (dataset === 'average-income') {
        value = feature.get('2022台灣所得data_平均數');
        ranges = [500, 1000, 1500, 2000]; // 例如所得平均數的級距
        colors = [
            'rgba(255, 235, 190, 0.6)',
            'rgba(255, 204, 128, 0.6)',
            'rgba(255, 153, 85, 0.6)',
            'rgba(255, 77, 77, 0.6)'
        ];
    } else if (dataset === 'median-income') {
        value = feature.get('2022台灣所得data_中位數');
        ranges = [300, 600, 900, 1200]; // 例如所得中位數的級距
        colors = [
            'rgba(230, 245, 208, 0.6)',
            'rgba(170, 220, 130, 0.6)',
            'rgba(110, 200, 80, 0.6)',
            'rgba(50, 150, 30, 0.6)'
        ];
    } else if (dataset === 'population') {
        value = feature.get('113年8月新北市各里人口數排行榜_合計');
        ranges = [1000, 3000, 5000, 10000]; // 例如人口數的級距
        colors = [
            'rgba(190, 235, 255, 0.6)',
            'rgba(128, 204, 255, 0.6)',
            'rgba(85, 153, 255, 0.6)',
            'rgba(77, 77, 255, 0.6)'
        ];
    }else{
        value = 0;
        ranges = [0]; 
        colors = [
            'rgba(255, 255, 255, 0.1)',
            ];
        }

    // 根據級距設定顏色
    let color = getColorForValue(value, ranges, colors);

    return new ol.style.Style({
        fill: new ol.style.Fill({
            color: color
        }),
        stroke: new ol.style.Stroke({
            color: 'black',
            width: 0.3
        })
    });
}

// 根據 value 落在哪個範圍來選擇對應的顏色
function getColorForValue(value, ranges, colors) {
    for (let i = 0; i < ranges.length; i++) {
        if (value < ranges[i]) {
            return colors[i];
        }
    }
    // 若超過最大範圍，使用最後一個顏色
    return colors[colors.length - 1];
}
    // 更新圖層樣式的函式
    function updateLayerStyle(dataset) {
        incomeLayer.setStyle(function(feature) {
            return getStyleByDataset(feature, dataset);
        });
    }

// 當使用者勾選不同的數據時觸發
document.querySelectorAll('.data-toggle').forEach(function(element) {
    element.addEventListener('change', function() {
        // 取消其他勾選框的選擇
        document.querySelectorAll('.data-toggle').forEach(function(el) {
            if (el !== element) {
                el.checked = false;
            }
        });

        // 取得目前選中的 dataset
        let dataset = this.getAttribute('data-dataset');

        // 更新圖層
        updateLayerStyle(dataset);

        // 檢查是否有任何 checkbox 被勾選
        let anyChecked = false;
        document.querySelectorAll('.data-toggle').forEach(function(el) {
            if (el.checked) {
                anyChecked = true;
            }
        });

        // 如果沒有任何 checkbox 被勾選，清除圖層
        if (!anyChecked) {

        }
    });
});


    </script>

    <script>
        // 取得 info 的 DOM 元素
    const info = document.getElementById('info');
    var infodisplay = 1;
    // 當滑鼠移動時處理 hover 事件
    map.on('pointermove', function(event) {
        if (infodisplay === 0) {
            return;
        }
        // 取得滑鼠位置對應的特徵
        map.forEachFeatureAtPixel(event.pixel, function(feature) {
            const districtName = feature.get('VILLAGE');  // 假設 GeoJSON 屬性包含 'name' 字段表示里名稱
            
            if (districtName) {
                // 顯示里名稱
                info.style.display = 'block';
                info.innerHTML = `${districtName}`;
                
                // 將 info 位置設置為滑鼠位置
                info.style.left = `${event.pixel[0] + 1}px`;
                info.style.top = `${event.pixel[1] + 1}px`;
            }
        }, {
            hitTolerance: 0  // 增加點擊範圍以提高用戶體驗
        });
    });
    
    // 當滑鼠離開地圖範圍時，隱藏 info
    map.getViewport().addEventListener('mouseout', function() {
        info.style.display = 'none';
    });
    
// 診所搜尋功能
var clinicList = document.getElementById('clinic-list');
var clinicSearch = document.getElementById('clinic-search');
fetch('新北市診所_經緯度.csv')
    .then(response => response.text())
    .then(csvText => {
        console.log('CSV data loaded successfully.'); // Debug: 確認CSV數據已經加載
        Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                console.log('Parsed CSV data:', results.data); // Debug: 顯示解析後的數據
                results.data.forEach(row => {
                    let name = row['機構名稱'];
                    let district = row['區名'];
                    let latitude = parseFloat(row['緯度']);
                    let longitude = parseFloat(row['經度']);

                    if (!isNaN(latitude) && !isNaN(longitude)) {
                        let option = document.createElement('option');
                        option.value = name; // 將診所名稱設為選項的值
                        option.text = name + ' (' + district + ')';
                        option.setAttribute('data-lat', latitude);   // 存儲緯度
                        option.setAttribute('data-lon', longitude);  // 存儲經度
                        clinicList.appendChild(option);
                        //console.log('Added option:', option.text); // Debug: 確認選項被添加
                    }
                });
            }
        });
    })
    .catch(error => {
        console.error('Error loading CSV:', error); // Debug: 加載CSV出錯
    });

clinicSearch.addEventListener('input', function() {
    let keyword = clinicSearch.value.trim();
    console.log('Search keyword:', keyword); // Debug: 顯示使用者輸入的搜索關鍵字

    // 此處可以自定義搜尋邏輯，例如過濾或高亮顯示符合的選項
});

// 監聽輸入框的 change 事件
clinicSearch.addEventListener('change', function() {
    let selectedClinicName = clinicSearch.value; // 獲取輸入框的值
    let options = clinicList.options;

    for (let i = 0; i < options.length; i++) {
        let option = options[i];
        if (option.value === selectedClinicName) {
            // 獲取對應的經緯度
            let latitude = parseFloat(option.getAttribute('data-lat'));
            let longitude = parseFloat(option.getAttribute('data-lon'));

            console.log('Selected clinic:', selectedClinicName); // Debug: 顯示選擇的診所名稱
            console.log('Latitude:', latitude, 'Longitude:', longitude); // Debug: 顯示診所的經緯度

            if (!isNaN(latitude) && !isNaN(longitude)) {
                let coordinates = ol.proj.fromLonLat([longitude, latitude]);  // 將經緯度轉換為地圖坐標
                console.log('Map coordinates:', coordinates); // Debug: 顯示轉換後的地圖坐標

                map.getView().animate({
                    center: coordinates,
                    zoom: 16
                });
                console.log('Map animation triggered.'); // Debug: 確認地圖動畫被觸發

                // 在這裡添加 popup 的顯示邏輯
                // 假設你有一個特徵對應於這個選項
                let feature = getFeatureByName(selectedClinicName); // 這是一個假設的函數，你需要根據實際情況獲取對應的特徵

                if (feature) {
                    var popupCoordinates = feature.getGeometry().getCoordinates(); // 獲取 popup 的位置
                    popup.setPosition(popupCoordinates); // 設置 popup 位置

                    var specialties = feature.get('specialties').split(',').map(function(specialty) {
                        return specialty.trim();
                    });
                    console.log(specialties);

                    var content = '<b>' + feature.get('name') + '</b><br>' +
                        '☎️電話: ' + feature.get('phone') + '<br>' +
                        '📓科別: ';

                    // Remove the last element from the list
                    specialties.pop();
                    specialties.forEach(function(specialty) {
                        content += '' + specialty + ' ';
                    });

                    if (feature.get('doctor') !== '0') {
                        content += '<br>💉醫師: ' + feature.get('doctor') + '位';
                    }
                    if (feature.get('TCM_doctor') !== '0') {
                        content += '<br>🌿中醫師: ' + feature.get('TCM_doctor') + '位';
                    }
                    if (feature.get('dentist') !== '0') {
                        content += '<br>🦷牙醫師: ' + feature.get('dentist') + '位';
                    }
                    if (feature.get('pharmacist') !== '0') {
                        content += '<br>💊藥師: ' + feature.get('pharmacist') + '位';
                    }
                    content += '<br>地址: ' + feature.get('address');

                    // 更新 popup 的內容
                    document.getElementById('popup-content').innerHTML = content;
                    document.getElementById('popup').style.display = 'block'; // 顯示 popup
                }
            } else {
                console.error('Invalid coordinates for the selected clinic.'); // Debug: 經緯度無效的錯誤訊息
            }
            break; // 找到對應選項後可跳出循環
        }
    }
});

// 假設的函數，根據診所名稱獲取相應的 feature
function getFeatureByName(name) {
    let foundFeature = null;
    map.getLayers().forEach(function(layer) {
        if (layer instanceof ol.layer.Vector) {
            layer.getSource().getFeatures().forEach(function(feature) {
                if (feature.get('name') === name) {
                    foundFeature = feature;
                }
            });
        }
    });
    return foundFeature;
}




    </script>


</body>
</html>
