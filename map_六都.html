<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¥ è¨ºæ‰€åœ°åœ– - å…­éƒ½</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol/ol.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/0.0.124/turf.min.js"></script>

    <style>
        
        body {
            font-family: Arial, sans-serif;
            /*å­—é«”é¡è‰²è—è‰²*/
            background-color: rgb(6, 6, 10);

        }
        #map {
            width: 100%;
            height: 80vh;
        }
        .layer-control {
            position: absolute;
            top: 50px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .layer-control label {
            display: block;
        }
        .ol-popup {
            position: absolute;
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ccc;
            bottom: 12px;
            left: -50px;
            min-width: 200px;
        }
        .ol-popup:after, .ol-popup:before {
            top: 100%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
        }
        .ol-popup:after {
            border-color: rgba(255, 255, 255, 0);
            border-top-color: white;
            border-width: 10px;
            left: 48px;
            margin-left: -10px;
        }
        .ol-popup:before {
            border-color: rgba(204, 204, 204, 0);
            border-top-color: #ccc;
            border-width: 11px;
            left: 48px;
            margin-left: -11px;
        }
        .ol-popup-closer {
            text-decoration: none;
            position: absolute;
            top: 2px;
            right: 8px;
        }
        .ol-popup-closer:after {
            content: "âœ–";
        }

        .search-container {
            position: absolute;  /* è®“æœå°‹æ¡†æ¼‚æµ®åœ¨åœ°åœ–ä¸Š */
            top: 100px;          /* å‚ç›´ä½ç½® */
            left: 50%;          /* æ°´å¹³ç½®ä¸­ */
            transform: translateX(-50%); /* æ°´å¹³ç½®ä¸­ */
            z-index: 1000;     /* ç¢ºä¿æœå°‹æ¡†åœ¨åœ°åœ–ä¹‹ä¸Š */
        }
        
        .search-input {
            font-size: 1.2rem;  /* å­—é«”å¤§å° */
            border-radius: 2rem; /* åœ“è§’ */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); /* è¼•å¾®é™°å½± */
        }
        
    </style>
</head>
<body>
    <h2 class="text-center my-4" style="color: rgb(255, 255, 255);">ğŸ¥ å…­éƒ½è¨ºæ‰€åœ°åœ–</h2>
    <div id="map"></div>
    <div class="layer-control mt-5">
    <h4 data-bs-toggle="collapse" href="#collapseBasemap" role="button" aria-expanded="false" aria-controls="collapseBasemap">ğŸ—ºï¸ åº•åœ–é¸æ“‡</h4>

    <div class="collapse my-2" id="collapseBasemap">
        <label><input type="radio" name="baseLayer" value="osm-standard"> OpenStreetMap æ¨™æº–</label>
        <label><input type="radio" name="baseLayer" value="cartodb-dark"> CartoDB Dark Matter</label>
        <label><input type="radio" name="baseLayer" value="google-satellite"> Google è¡›æ˜Ÿ</label>
        <label><input type="radio" name="baseLayer" value="cartodb-positron" checked> CartoDB Positron</label>
        
    </div>

    <h4 data-bs-toggle="collapse" href="#collapseDistrict" role="button" aria-expanded="false" aria-controls="collapseDistrict">ğŸ©º è¡Œæ”¿å€è¨ºæ‰€è³‡æ–™</h4>
    <div class="collapse my-2" id="collapseDistrict" style="max-height: 300px; overflow-y: auto;">
        <div class="d-flex align-middle">

        <h5 data-bs-toggle="collapse" href="#collapseTaipei" role="button" aria-expanded="false" aria-controls="collapseTaipei">å°åŒ—å¸‚
        </h5>
        <button class="jump-to-city btn btn-sm" data-city="taipei" style="margin-left: 1px;">ğŸ“è·³è½‰</button>
         </div>
        <div class="collapse my-2" id="collapseTaipei" style="max-height: 300px; overflow-y: auto;">
        <label><input type="checkbox" class="district-toggle" data-district="ä¸­æ­£å€" > ä¸­æ­£å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="å¤§åŒå€" > å¤§åŒå€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="ä¸­å±±å€" > ä¸­å±±å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="æ¾å±±å€" > æ¾å±±å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="å¤§å®‰å€" > å¤§å®‰å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="è¬è¯å€" > è¬è¯å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="ä¿¡ç¾©å€" > ä¿¡ç¾©å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="å£«æ—å€" > å£«æ—å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="åŒ—æŠ•å€" > åŒ—æŠ•å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="å…§æ¹–å€" > å…§æ¹–å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="å—æ¸¯å€" > å—æ¸¯å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="æ–‡å±±å€" > æ–‡å±±å€<span class="clinic-count"></span></label>
        </div>
        <div class="d-flex align-middle">

        <h5 data-bs-toggle="collapse" href="#collapseNewTaipei" role="button" aria-expanded="false" aria-controls="collapseNewTaipei">æ–°åŒ—å¸‚
        </h5>
        <button class="jump-to-city btn btn-sm" data-city="newtaipei" style="margin-left: 1px;">ğŸ“è·³è½‰</button>
        </div>
        <div class="collapse my-2" id="collapseNewTaipei" style="max-height: 300px; overflow-y: auto;">
        <label><input type="checkbox" class="district-toggle" data-district="æ¿æ©‹å€" > æ¿æ©‹å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="æ–°èŠå€" > æ–°èŠå€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="ä¸­å’Œå€" > ä¸­å’Œå€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="æ°¸å’Œå€" > æ°¸å’Œå€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="åœŸåŸå€" > åœŸåŸå€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="ä¸‰é‡å€" > ä¸‰é‡å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="è˜†æ´²å€" > è˜†æ´²å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="äº”è‚¡å€" > äº”è‚¡å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="æ³°å±±å€" > æ³°å±±å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="æ—å£å€" > æ—å£å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="ä¸‰å³½å€" > ä¸‰å³½å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="æ¨¹æ—å€" > æ¨¹æ—å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="é¶¯æ­Œå€" > é¶¯æ­Œå€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="æ·¡æ°´å€" > æ·¡æ°´å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="å…«é‡Œå€" > å…«é‡Œå€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="ä¸‰èŠå€" > ä¸‰èŠå€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="çŸ³é–€å€" > çŸ³é–€å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="é‡‘å±±å€" > é‡‘å±±å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="è¬é‡Œå€" > è¬é‡Œå€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="æ±æ­¢å€" > æ±æ­¢å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="ç‘èŠ³å€" > ç‘èŠ³å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="å¹³æºªå€" > å¹³æºªå€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="é›™æºªå€" > é›™æºªå€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="è²¢å¯®å€" > è²¢å¯®å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="æ·±å‘å€" > æ·±å‘å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="çŸ³ç¢‡å€" > çŸ³ç¢‡å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="æ–°åº—å€" > æ–°åº—å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="åªæ—å€" > åªæ—å€<span class="clinic-count"></span></label>
        <label><input type="checkbox" class="district-toggle" data-district="çƒä¾†å€" > çƒä¾†å€<span class="clinic-count"></span></label>
        </div>
        <div class="d-flex align-middle">
        <h5 data-bs-toggle="collapse" href="#collapseTaichung" role="button" aria-expanded="false" aria-controls="collapseTaichung">å°ä¸­å¸‚
        </h5>
        <button class="jump-to-city btn btn-sm" data-city="taichung" style="margin-left: 1px;">ğŸ“è·³è½‰</button>
        </div>
        <div class="collapse my-2" id="collapseTaichung" style="max-height: 300px; overflow-y: auto;">
            <label><input type="checkbox" class="district-toggle" data-district="ä¸­å€" > ä¸­å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ±å€" > æ±å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å—å€" > å—å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="è¥¿å€" > è¥¿å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="åŒ—å€" > åŒ—å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="åŒ—å±¯å€" > åŒ—å±¯å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="è¥¿å±¯å€" > è¥¿å±¯å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å—å±¯å€" > å—å±¯å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å¤ªå¹³å€" > å¤ªå¹³å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å¤§é‡Œå€" > å¤§é‡Œå€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="éœ§å³°å€" > éœ§å³°å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="çƒæ—¥å€" > çƒæ—¥å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="è±åŸå€" > è±åŸå€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="åé‡Œå€" > åé‡Œå€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ±å‹¢å€" > æ±å‹¢å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="çŸ³å²¡å€" > çŸ³å²¡å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ–°ç¤¾å€" > æ–°ç¤¾å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ½­å­å€" > æ½­å­å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å¤§é›…å€" > å¤§é›…å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="ç¥å²¡å€" > ç¥å²¡å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å¤§è‚šå€" > å¤§è‚šå€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ²™é¹¿å€" > æ²™é¹¿å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="é¾äº•å€" > é¾äº•å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ¢§æ£²å€" > æ¢§æ£²å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ¸…æ°´å€" > æ¸…æ°´å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å¤§ç”²å€" > å¤§ç”²å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å¤–åŸ”å€" > å¤–åŸ”å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å¤§å®‰å€" > å¤§å®‰å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å’Œå¹³å€" > å’Œå¹³å€<span class="clinic-count"></span></label>
        </div>
        <div class="d-flex align-middle">
        <h5 data-bs-toggle="collapse" href="#collapseTainan" role="button" aria-expanded="false" aria-controls="collapseTainan">å°å—å¸‚
        </h5>
        <button class="jump-to-city btn btn-sm" data-city="tainan" style="margin-left: 1px;">ğŸ“è·³è½‰</button>
        </div>
        <div class="collapse my-2" id="collapseTainan" style="max-height: 300px; overflow-y: auto;">
            <label><input type="checkbox" class="district-toggle" data-district="ä¸­è¥¿å€" > ä¸­è¥¿å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ±å€" > æ±å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å—å€" > å—å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="åŒ—å€" > åŒ—å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å®‰å¹³å€" > å®‰å¹³å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å®‰å—å€" > å®‰å—å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ°¸åº·å€" > æ°¸åº·å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ­¸ä»å€" > æ­¸ä»å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ–°åŒ–å€" > æ–°åŒ–å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å·¦é®å€" > å·¦é®å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="ç‰äº•å€" > ç‰äº•å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ¥ è¥¿å€" > æ¥ è¥¿å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å—åŒ–å€" > å—åŒ–å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="ä»å¾·å€" > ä»å¾·å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="é—œå»Ÿå€" > é—œå»Ÿå€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="é¾å´å€" > é¾å´å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å®˜ç”°å€" > å®˜ç”°å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="éº»è±†å€" > éº»è±†å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="ä½³é‡Œå€" > ä½³é‡Œå€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="è¥¿æ¸¯å€" > è¥¿æ¸¯å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="ä¸ƒè‚¡å€" > ä¸ƒè‚¡å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å°‡è»å€" > å°‡è»å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å­¸ç”²å€" > å­¸ç”²å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="åŒ—é–€å€" > åŒ—é–€å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ–°ç‡Ÿå€" > æ–°ç‡Ÿå€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å¾Œå£å€" > å¾Œå£å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="ç™½æ²³å€" > ç™½æ²³å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ±å±±å€" > æ±å±±å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å…­ç”²å€" > å…­ç”²å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="ä¸‹ç‡Ÿå€" > ä¸‹ç‡Ÿå€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æŸ³ç‡Ÿå€" > æŸ³ç‡Ÿå€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="é¹½æ°´å€" > é¹½æ°´å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å–„åŒ–å€" > å–„åŒ–å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å¤§å…§å€" > å¤§å…§å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å±±ä¸Šå€" > å±±ä¸Šå€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ–°å¸‚å€" > æ–°å¸‚å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å®‰å®šå€" > å®‰å®šå€<span class="clinic-count"></span></label>
        </div>
        <div class="d-flex align-middle">

        <h5 data-bs-toggle="collapse" href="#collapseKaohsiung" role="button" aria-expanded="false" aria-controls="collapseKaohsiung">é«˜é›„å¸‚
        </h5>
        <button class="jump-to-city btn btn-sm" data-city="kaohsiung" style="margin-left: 1px;">ğŸ“è·³è½‰</button>

        </div>
        <div class="collapse my-2" id="collapseKaohsiung" style="max-height: 300px; overflow-y: auto;">
            <label><input type="checkbox" class="district-toggle" data-district="æ–°èˆˆå€" > æ–°èˆˆå€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å‰é‡‘å€" > å‰é‡‘å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="è‹“é›…å€" > è‹“é›…å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="é¹½åŸ•å€" > é¹½åŸ•å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="é¼“å±±å€" > é¼“å±±å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ——æ´¥å€" > æ——æ´¥å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å‰é®å€" > å‰é®å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="ä¸‰æ°‘å€" > ä¸‰æ°‘å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ¥ æ¢“å€" > æ¥ æ¢“å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å°æ¸¯å€" > å°æ¸¯å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å·¦ç‡Ÿå€" > å·¦ç‡Ÿå€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="ä»æ­¦å€" > ä»æ­¦å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å¤§ç¤¾å€" > å¤§ç¤¾å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å²¡å±±å€" > å²¡å±±å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="è·¯ç«¹å€" > è·¯ç«¹å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="é˜¿è“®å€" > é˜¿è“®å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="ç”°å¯®å€" > ç”°å¯®å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="ç‡•å·¢å€" > ç‡•å·¢å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ©‹é ­å€" > æ©‹é ­å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ¢“å®˜å€" > æ¢“å®˜å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å½Œé™€å€" > å½Œé™€å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ°¸å®‰å€" > æ°¸å®‰å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ¹–å…§å€" > æ¹–å…§å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="é³³å±±å€" > é³³å±±å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å¤§å¯®å€" > å¤§å¯®å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ—åœ’å€" > æ—åœ’å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="é³¥æ¾å€" > é³¥æ¾å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å¤§æ¨¹å€" > å¤§æ¨¹å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ——å±±å€" > æ——å±±å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="ç¾æ¿ƒå€" > ç¾æ¿ƒå€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å…­é¾œå€" > å…­é¾œå€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å…§é–€å€" > å…§é–€å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ‰æ—å€" > æ‰æ—å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="ç”²ä»™å€" > ç”²ä»™å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ¡ƒæºå€" > æ¡ƒæºå€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="é‚£ç‘ªå¤å€" > é‚£ç‘ªå¤å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="èŒ‚æ—å€" > èŒ‚æ—å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="èŒ„è£å€" > èŒ„è£å€<span class="clinic-count"></span></label>
        </div>
        <div class="d-flex align-middle">

        <h5 data-bs-toggle="collapse" href="#collapseTaoyuan" role="button" aria-expanded="false" aria-controls="collapseTaoyuan">æ¡ƒåœ’å¸‚
        </h5>
        <button class="jump-to-city btn btn-sm" data-city="taoyuan" style="margin-left: 1px;">ğŸ“è·³è½‰</button>

        </div>
        <div class="collapse my-2" id="collapseTaoyuan" style="max-height: 300px; overflow-y: auto;">
            <label><input type="checkbox" class="district-toggle" data-district="æ¡ƒåœ’å€" > æ¡ƒåœ’å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="ä¸­å£¢å€" > ä¸­å£¢å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å¹³é®å€" > å¹³é®å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å…«å¾·å€" > å…«å¾·å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ¥Šæ¢…å€" > æ¥Šæ¢…å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="è˜†ç«¹å€" > è˜†ç«¹å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å¤§æºªå€" > å¤§æºªå€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="é¾æ½­å€" > é¾æ½­å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="é¾œå±±å€" > é¾œå±±å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å¤§åœ’å€" > å¤§åœ’å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="è§€éŸ³å€" > è§€éŸ³å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="æ–°å±‹å€" > æ–°å±‹å€<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="district-toggle" data-district="å¾©èˆˆå€" > å¾©èˆˆå€<span class="clinic-count"></span></label>
        </div>
        
        <!-- æ ¹æ“šå¯¦éš›è¡Œæ”¿å€åç¨±ç”Ÿæˆé¸æ“‡æ¡† -->
 
        <!-- æ·»åŠ å…¶ä»–è¡Œæ”¿å€ -->
    </div>

    <h4 data-bs-toggle="collapse" href="#collapseLayer" role="button" aria-expanded="false" aria-controls="collapseLayer">ğŸ“Œ åœ–è³‡</h4>

    <div class="collapse my-2" id="collapseLayer">
            <label><input type="checkbox" class="data-toggle" data-dataset="average-income"> æ‰€å¾—å¹³å‡æ•¸<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="data-toggle" data-dataset="median-income"> æ‰€å¾—ä¸­ä½æ•¸<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="data-toggle" data-dataset="population"> äººå£æ•¸<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="data-toggle" data-dataset="elder-index"> è€åŒ–æŒ‡æ•¸<span class="clinic-count"></span></label>
            <label><input type="checkbox" class="data-toggle" data-dataset="none"> é—œé–‰<span class="clinic-count"></span></label>
            <!--<label>âœ¨æ›´å¤šåœ–è³‡æº–å‚™ä¸­âœ¨</label>-->
            <!-- è‰²ç¥¨å±•ç¤ºå€åŸŸ -->
            <div id="color-legend" style="margin-top: 10px;"></div>
    </div>

    <h4 data-bs-toggle="collapse" href="#collapseSpecialty" role="button" aria-expanded="false" aria-controls="collapseSpecialty">â• ç§‘åˆ¥</h4>

    <div class="collapse my-2" id="collapseSpecialty" style="max-height: 300px; overflow-y: auto;">
        <div>
            <input type="checkbox" id="select-all-specialties" checked> å…¨é¸/å…¨ä¸é¸
        </div>
        <div id="specialty-container"></div>
    </div>

    <h4 data-bs-toggle="collapse" href="#collapseTools" role="button" aria-expanded="false" aria-controls="collapseTools">ğŸ§° å°å·¥å…·</h4>
    <div class="collapse my-2" id="collapseTools">
        <button id="draw-point" class="btn btn-primary my-2">ğ’Š¹ é»</button>
        <button id="draw-line" class="btn btn-primary"> â®‘ ç·š</button>
        
        <button id="draw-polygon" class="btn btn-primary">â­“ é¢</button><br>
        <button id="clear-drawings" class="btn btn-danger my-2">æ¸…é™¤æ¨™è¨˜</button>
        <button id="end-drawing" class="btn btn-info my-2">çµæŸç¹ªåœ–</button>
        <p id="measure-result"></p>
        <label for="radius-input">è¨­å®šåŠå¾‘ï¼ˆå…¬é‡Œï¼‰:</label>
        <input type="number" id="radius-input" min="0.1" step="0.1" value="1" style="width: 50px;">
        <button id="draw-circle">ç•«åœ“</button>

    </div>
</div>
    <!-- Popup HTML -->
    <div id="popup" class="ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content"></div>
    </div>
    <!-- Hoveré¡¯ç¤ºé‡Œçš„åç¨± -->
    <div id="info" style="position: absolute; background: white; padding: 5px; border: 1px solid black; display: none;"></div>
    <!-- è¨ºæ‰€è³‡æ–™æŸ¥è©¢ -->
    <div class="search-container">
        <input type="text" id="clinic-search" list="clinic-list" placeholder="æœå°‹è¨ºæ‰€..." class="form-control search-input">
        <datalist id="clinic-list"></datalist>
    </div>
    
    <script>

// é è¨­å°åŒ—å¸‚çš„ä¸­å¿ƒåº§æ¨™ (ç¶“åº¦, ç·¯åº¦)
var taipeiCenter = [121.5654, 25.0330]; // å°åŒ—å¸‚ä¿¡ç¾©å€ç¶“ç·¯åº¦
taipeiCenter = ol.proj.fromLonLat(taipeiCenter); // è½‰æ›ç¶“ç·¯åº¦ç‚ºåœ°åœ–æŠ•å½±åº§æ¨™

// å»ºç«‹åœ°åœ–åœ–å±¤
var map = new ol.Map({
    target: 'map',
    layers: [
        new ol.layer.Tile({
            source: new ol.source.OSM(), // OpenStreetMap æ¨™æº–
            title: 'osm-standard',
            visible: false
        }),
        new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://{a-c}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png' // CartoDB Dark Matter
            }),
            title: 'cartodb-dark',
            visible: false
        }),
        new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}' // Google è¡›æ˜Ÿåœ–å±¤
            }),
            title: 'google-satellite',
            visible: false
        }),
        new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://{a-c}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png' // CartoDB Light
            }),
            title: 'cartodb-positron',
            visible: true
        })
    ],
    view: new ol.View({
        center: taipeiCenter,
        zoom: 12 // é è¨­ç¸®æ”¾æ¯”ä¾‹
    })
});
// å®šç¾©ç¹ªåœ–å±¤å’Œç¹ªåœ–æº
let isDrawing = false; // ç”¨ä¾†åˆ¤æ–·æ˜¯å¦åœ¨ç¹ªåœ–æ¨¡å¼
var source = new ol.source.Vector();
var vectorLayer = new ol.layer.Vector({
    source: source,
    style: new ol.style.Style({
        fill: new ol.style.Fill({
            color: 'rgba(255, 255, 255, 0.9)'
        }),
        stroke: new ol.style.Stroke({
            color: 'red',
            width: 2
        }),
        image: new ol.style.Circle({
            radius: 7,
            fill: new ol.style.Fill({
                color: 'red'
            })
        })
    })
});
map.addLayer(vectorLayer);

// åˆå§‹åŒ–ç¹ªåœ–å·¥å…·è®Šé‡
var draw;
var measureTooltipElement;
var measureTooltip;
var listener;

// æ·»åŠ æ¸¬é‡å·¥å…·æç¤º
function createMeasureTooltip() {
    if (measureTooltipElement) {
        measureTooltipElement.parentNode.removeChild(measureTooltipElement);
    }
    measureTooltipElement = document.createElement('div');
    measureTooltipElement.className = 'ol-tooltip ol-tooltip-measure';
    measureTooltip = new ol.Overlay({
        element: measureTooltipElement,
        offset: [0, -15],
        positioning: 'bottom-center'
    });
    map.addOverlay(measureTooltip);
}

// ç¹ªåœ–äº¤äº’åŠŸèƒ½
function addInteraction(type) {
    draw = new ol.interaction.Draw({
        source: source,
        type: type
    });

    // ç•¶ç”¨æˆ¶é–‹å§‹ç¹ªè£½æ™‚ï¼Œé¡¯ç¤ºæ¸¬é‡çµæœ
    draw.on('drawstart', function (evt) {
        createMeasureTooltip();
        var sketch = evt.feature;

        // ç›£è½ç¹ªè£½éç¨‹
        listener = sketch.getGeometry().on('change', function (event) {
            var geom = event.target;
            var output;
            var tooltipCoord;

            if (geom instanceof ol.geom.Polygon) {
                output = formatArea(geom); // é¡¯ç¤ºé¢ç©
                tooltipCoord = geom.getInteriorPoint().getCoordinates();
            } else if (geom instanceof ol.geom.LineString) {
                output = formatLength(geom); // é¡¯ç¤ºè·é›¢
                tooltipCoord = geom.getLastCoordinate();
            }
            measureTooltipElement.innerHTML = output;
            measureTooltip.setPosition(tooltipCoord);
        });
    });

    // å®Œæˆç¹ªåœ–
    draw.on('drawend', function (evt) {
        measureTooltipElement.className = 'ol-tooltip ol-tooltip-static';
        measureTooltip.setOffset([0, -7]);
        measureTooltipElement = null;
        ol.Observable.unByKey(listener); // åœæ­¢ç›£è½

        // ä¿ç•™æ¸¬é‡æç¤º
        createMeasureTooltip(); // ç¢ºä¿æ–°æç¤ºæ¡†åœ¨ä¸‹ä¸€æ¬¡ç¹ªè£½æ™‚ä¸è¦†è“‹å·²æœ‰çš„æç¤º
    });

    map.addInteraction(draw);
}

// æ ¼å¼åŒ–è·é›¢
function formatLength(line) {
    var length = ol.sphere.getLength(line);
    var output;
    if (length > 1000) {
        output = (length / 1000).toFixed(2) + ' km';
    } else {
        output = length.toFixed(2) + ' m';
    }
    return output;
}

// æ ¼å¼åŒ–é¢ç©
function formatArea(polygon) {
    var area = ol.sphere.getArea(polygon);
    var output;
    if (area > 10000) {
        //output = (area / 10000).toFixed(2) + ' ha';
        output = (area/1000000).toFixed(2) + ' kmÂ²';
    } else {
        output = (area/1000000).toFixed(2) + ' kmÂ²';
    }
    return output;
}

// é»ã€ç·šã€é¢çš„ç¹ªåœ–æŒ‰éˆ•
document.getElementById('draw-point').onclick = function () {
    map.removeInteraction(draw);
    isDrawing = true; // é€²å…¥ç¹ªåœ–æ¨¡å¼
    addInteraction('Point');
};
document.getElementById('draw-line').onclick = function () {
    map.removeInteraction(draw);
    isDrawing = true; // é€²å…¥ç¹ªåœ–æ¨¡å¼
    addInteraction('LineString');
};
document.getElementById('draw-polygon').onclick = function () {
    map.removeInteraction(draw);
    isDrawing = true; // é€²å…¥ç¹ªåœ–æ¨¡å¼
    addInteraction('Polygon');
};

// æ–°å¢ã€ŒçµæŸç¹ªåœ–ã€æŒ‰éˆ•çš„åŠŸèƒ½
document.getElementById('end-drawing').onclick = function () {
    map.removeInteraction(draw); // åœæ­¢ç¹ªåœ–äº’å‹•
    isDrawing = false; // é›¢é–‹ç¹ªåœ–æ¨¡å¼
};
// æ¸…é™¤ç¹ªåœ–åŠŸèƒ½
document.getElementById('clear-drawings').onclick = function () {
    isDrawing = false; // é›¢é–‹ç¹ªåœ–æ¨¡å¼

    source.clear();
    map.getOverlays().clear(); // æ¸…é™¤æ¸¬é‡æç¤º
    // æ¸…é™¤åœ“å½¢åœ–å±¤
    if (circleLayer) {
        map.removeLayer(circleLayer); // ç§»é™¤åœ“å½¢åœ–å±¤
        circleLayer = null; // é‡ç½®åœ“å½¢åœ–å±¤è®Šæ•¸
    }

    };

//åŠå¾‘ç•«åœ“
let radiusInKm = 1; // é è¨­åŠå¾‘ç‚º1å…¬é‡Œ
let circleLayer; // ç”¨ä¾†å­˜å„²åœ“å½¢åœ–å±¤
document.getElementById('radius-input').addEventListener('input', function (event) {
    radiusInKm = parseFloat(event.target.value);
});
document.getElementById('draw-circle').onclick = function () {
    isDrawing = true; // é€²å…¥ç¹ªåœ–æ¨¡å¼
    map.once('click', function (evt) {
        const center = evt.coordinate; // ä½¿ç”¨è€…é»æ“Šçš„åœ°åœ–åº§æ¨™
        const radiusInMeters = radiusInKm * 1000; // å°‡å…¬é‡Œè½‰æ›ç‚ºç±³

        // å»ºç«‹åœ“å½¢åœ–å½¢
        const circle = new ol.geom.Circle(center, radiusInMeters);
        const circleFeature = new ol.Feature(circle);

        const vectorSource = new ol.source.Vector({
            features: [circleFeature]
        });

        // å»ºç«‹åœ–å±¤
        circleLayer = new ol.layer.Vector({
            source: vectorSource,
            style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'blue',
                    width: 2
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(0, 0, 255, 0.1)'
                })
            })
        });

        map.addLayer(circleLayer); // åŠ å…¥åœ–å±¤
        //ç­‰å¾…1ç§’
        setTimeout(function () {
            isDrawing = false; // é›¢é–‹ç¹ªåœ–æ¨¡å¼
        }, 1000);

    });
};


// åœ–å±¤åˆ‡æ›åŠŸèƒ½
document.querySelectorAll('input[name="baseLayer"]').forEach(function(element) {
    element.addEventListener('change', function() {
        var selectedLayer = this.value;
        map.getLayers().forEach(function(layer) {
            // åªåˆ‡æ›åº•åœ–åœ–å±¤çš„é¡¯ç¤ºç‹€æ…‹
            if (layer instanceof ol.layer.Tile) {
                layer.setVisible(layer.get('title') === selectedLayer);
            }
        });
    });
});

function addIncomeLayer(cityName, geojsonUrl) {
    var incomeLayer = new ol.layer.Vector({
        source: new ol.source.Vector({
            url: geojsonUrl, // GeoJSON æª”æ¡ˆè·¯å¾‘
            format: new ol.format.GeoJSON()
        }),
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: '#319FD3',
                width: 2
            }),
            fill: new ol.style.Fill({
                color: 'rgba(0, 255, 255, 0.1)'  // ä½ å¯ä»¥æ ¹æ“šä¸åŒåŸå¸‚è‡ªè¨‚é¡è‰²
            })
        })
    });
    
    incomeLayer.set('name', cityName);  // ç‚ºåœ–å±¤è¨­å®šåç¨±ä»¥ä¾¿å¾ŒçºŒç®¡ç†
    map.addLayer(incomeLayer);
}

//è·³è½‰åˆ°ä¸åŒç¸£å¸‚
var cityCenters = {
    taipei: ol.proj.fromLonLat([121.5654, 25.0330]), // å°åŒ—å¸‚
    newtaipei: ol.proj.fromLonLat([121.4633, 25.0173]), // æ–°åŒ—å¸‚
    taoyuan: ol.proj.fromLonLat([121.3015, 24.9930]), // æ¡ƒåœ’å¸‚
    taichung: ol.proj.fromLonLat([120.6736, 24.1477]), // å°ä¸­å¸‚
    tainan: ol.proj.fromLonLat([120.2270, 22.9999]), // å°å—å¸‚
    kaohsiung: ol.proj.fromLonLat([120.3014, 22.6273]) // é«˜é›„å¸‚
};
document.querySelectorAll('.jump-to-city').forEach(button => {
    button.onclick = function () {
        var city = this.getAttribute('data-city'); // å–å¾—åŸå¸‚çš„è³‡æ–™
        var center = cityCenters[city]; // å–å¾—åŸå¸‚ä¸­å¿ƒåº§æ¨™
        
        map.getView().animate({
            center: center,
            zoom: 12, // è¨­å®šæƒ³è¦çš„ç¸®æ”¾æ¯”ä¾‹
            duration: 1000 // å‹•ç•«æŒçºŒæ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
        });
    };
});

// æ·»åŠ å°åŒ—å¸‚çš„æ”¶å…¥åœ–å±¤
addIncomeLayer('Taipei', 'tpe_income4.geojson');

// æ·»åŠ æ–°åŒ—å¸‚çš„æ”¶å…¥åœ–å±¤
addIncomeLayer('New Taipei', 'newtpe_income.geojson');

// æ·»åŠ å°ä¸­å¸‚çš„æ”¶å…¥åœ–å±¤
addIncomeLayer('Taichung', 'taichung_income2.geojson');

// æ·»åŠ å°å—å¸‚çš„æ”¶å…¥åœ–å±¤
addIncomeLayer('Tainan', 'tainan_income.geojson');

// æ·»åŠ é«˜é›„å¸‚çš„æ”¶å…¥åœ–å±¤
addIncomeLayer('Kaohsiung', 'kaohsiung_income.geojson');

// æ·»åŠ æ¡ƒåœ’å¸‚çš„æ”¶å…¥åœ–å±¤
addIncomeLayer('Taoyuan', 'taoyuan_income.geojson');

/// éš¨æ©Ÿç”Ÿæˆé¡è‰²çš„å‡½æ•¸
function getRandomColor() {
    const letters = '0123456789ABCDEF';
    let color = '#';
    for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
}
// å®šç¾©50ç¨®é®®è‰·é¡è‰²çš„æ•¸çµ„
const vibrantColors = [
    '#FF5733', // é®®ç´…
    '#FF8C00', // æ©˜è‰²
    '#FFD700', // é‡‘è‰²
    '#32CD32', // ç¿ ç¶ è‰²
    '#4682B4', // é‹¼è—è‰²
    '#6A5ACD', // æœéµ‘ç´«
    '#FF69B4', // ç²‰ç´…è‰²
    '#CD5C5C', // å°åº¦ç´…
    '#20B2AA', // æ·¡æµ·æ´‹ç¶ 
    '#FF4500', // æ©™ç´…è‰²
    '#8B008B', // æ·±ç´«ç´…è‰²
    '#7FFF00', // æŸ¥ç‰¹ç•™æ–¯ç¶ 
    '#FFA07A', // æ·ºé®­ç´…
    '#FF6347', // ç•ªèŒ„è‰²
    '#FFDAB9', // æ¡ƒè‰²
    '#98FB98', // æ·ºç¶ è‰²
    '#FF1493', // æ·±ç²‰ç´…è‰²
    '#FFB6C1', // æ·ºç²‰ç´…è‰²
    '#AFEEEE', // æ·ºé’è‰²
    '#B22222', // é®®ç´…è‰²
    '#5F9EA0', // é†œè—
    '#4B0082', // é›é’è‰²
    '#D2691E', // å·§å…‹åŠ›è‰²
    '#8FBC8F', // æ·±ç¶ è‰²
    '#FFD700', // é‡‘é»ƒè‰²
    '#FFC0CB', // ç²‰ç´…è‰²
    '#FF7F50', // çŠç‘šè‰²
    '#6495ED', // ç‰ç±³èŠ±è—
    '#3CB371', // ä¸­æµ·æ´‹ç¶ 
    '#FF4500', // æ©™ç´…è‰²
    '#ADFF2F', // è‰ç¶ è‰²
    '#7B68EE', // æ¿ƒè—è‰²
    '#483D8B', // æ·±è—è‰²
    '#2E8B57', // æµ·æ´‹ç¶ 
    '#6B8E23', // æ©„æ¬–ç¶ 
    '#F0E68C', // å¡å…¶è‰²
    '#DDA0DD', // é¬±é‡‘é¦™ç´«
    '#FF1493', // æ·±ç²‰ç´…
    '#8B4513', // é§è‰²
    '#B8860B', // é‡‘è‰²
    '#D8BFD8', // é¬±é‡‘é¦™ç´«
    '#E6E6FA', // è–°è¡£è‰ç´«
    '#DCDCDC', // é‰›ç°è‰²
    '#A0522D', // é®®åœŸè‰²
    '#7B68EE', // æ¿ƒè—è‰²
    '#F08080', // æ·ºç´…è‰²
    '#20B2AA', // æ·¡æµ·æ´‹ç¶ 
    '#FF6347', // ç•ªèŒ„è‰²
    '#FFEFD5', // é­šè‚šç™½
    '#98FB98', // æ·ºç¶ è‰²
    '#FFE4E1', // è«è˜­è¿ªè‰²
    '#FFB6C1', // æ·ºç²‰ç´…è‰²
    '#ADD8E6', // æ·ºè—è‰²
    '#F5F5DC', // ç±³è‰²
    '#FAFAD2', // æ·¡é‡‘è‰²
    '#DDA0DD'  // é¬±é‡‘é¦™ç´«
];

var vectorSources = {}; // å„²å­˜å„è¡Œæ”¿å€çš„è³‡æ–™ä¾†æº

function loadClinicData(cityName, csvFilePath) {
    var vectorLayers = {}; // å„²å­˜å„è¡Œæ”¿å€çš„è¨ºæ‰€åœ–å±¤
    var specialtyColors = {}; // å„²å­˜ç§‘åˆ¥é¡è‰²çš„å°æ‡‰è¡¨
    let colorIndex = 0; // ç”¨ä¾†è¨˜éŒ„ç•¶å‰é¡è‰²ç´¢å¼•
    let specialtySet = new Set(); // å„²å­˜ç§‘åˆ¥çš„é›†åˆ
    
    fetch(csvFilePath)
        .then(response => response.text())
        .then(csvText => {
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    let districtCounts = {}; // å„²å­˜æ¯å€‹è¡Œæ”¿å€çš„è¨ºæ‰€æ•¸é‡

                    results.data.forEach(row => {
                        let name = row['æ©Ÿæ§‹åç¨±'];
                        if(name === undefined){
                            return;
                        }
                        let phone = row['é›»è©±'];
                        let address = row['åœ°å€'];
                        let district = row['å€å'];
                        let doctor = row['Aé†«å¸«'];
                        let TCM_doctor = row['Bä¸­é†«å¸«'];
                        let dentist = row['Cç‰™é†«å¸«'];
                        let pharmacist = row['Dè—¥å¸«'];
                        let specialties = row['ç§‘åˆ¥'] ? row['ç§‘åˆ¥'].split(',').map(function(specialty) {
                            return specialty.trim();
                        }).filter(function(specialty) {
                            return specialty !== '';
                        }) : [];
                        let latitude = parseFloat(row['ç·¯åº¦']);
                        let longitude = parseFloat(row['ç¶“åº¦']);
                        
                        if (!isNaN(latitude) && !isNaN(longitude)) {
                            let coordinates = ol.proj.fromLonLat([longitude, latitude]);

                            if (!vectorSources[district]) {
                                vectorSources[district] = new ol.source.Vector();
                                vectorLayers[district] = new ol.layer.Vector({
                                    source: vectorSources[district],
                                    visible: false,
                                    title: cityName + ' - ' + district
                                });
                                map.addLayer(vectorLayers[district]);
                            }

                            specialties.forEach(function(specialty) {
                                specialtySet.add(specialty);

                                if (!specialtyColors[specialty]) {
                                    specialtyColors[specialty] = vibrantColors[colorIndex % vibrantColors.length];
                                    colorIndex++;
                                }

                                let marker = new ol.Feature({
                                    geometry: new ol.geom.Point(coordinates),
                                    name: name,
                                    phone: phone,
                                    address: address,
                                    doctor: doctor,
                                    TCM_doctor: TCM_doctor,
                                    dentist: dentist,
                                    pharmacist: pharmacist,
                                    specialties: specialty,
                                });

                                let fillColor = specialtyColors[specialty];
                                marker.setStyle(new ol.style.Style({
                                    image: new ol.style.Circle({
                                        radius: 6,
                                        fill: new ol.style.Fill({
                                            color: fillColor
                                        }),
                                        stroke: new ol.style.Stroke({
                                            color: 'white',
                                            width: 1.5
                                        })
                                    })
                                }));

                                vectorSources[district].addFeature(marker);
                            });

                            if (!districtCounts[district]) {
                                districtCounts[district] = 0;
                            }
                            districtCounts[district]++;
                        }
                    });

                    // å‹•æ…‹ç”Ÿæˆç§‘åˆ¥çš„ HTML æ¬„ä½
                    let specialtyContainer = document.getElementById('specialty-container');
                    specialtySet.forEach(function(specialty) {
                        let label = document.createElement('label');

                        let checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'specialty-toggle';
                        checkbox.setAttribute('data-specialty', specialty);
                        checkbox.checked = true;

                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(' ' + specialty));
                        label.appendChild(document.createElement('span')).className = 'clinic-count';

                        specialtyContainer.appendChild(label);
                    });

                    // æ›´æ–°è¡Œæ”¿å€è¨ºæ‰€æ•¸é‡é¡¯ç¤º
                    document.querySelectorAll('.district-toggle').forEach(function(element) {
                        let district = element.getAttribute('data-district');
                        if (districtCounts[district]) {
                            element.nextElementSibling.innerHTML = 
                            ' (' + districtCounts[district] + 'é–“è¨ºæ‰€)';
                        }
                    });

                    // æ ¹æ“šé¸æ“‡é¡¯ç¤ºæˆ–éš±è—è¡Œæ”¿å€çš„è¨ºæ‰€
                    document.querySelectorAll('.district-toggle').forEach(function(element) {
                        element.addEventListener('change', function() {
                            let district = this.getAttribute('data-district');
                            if (vectorLayers[district]) {
                                vectorLayers[district].setVisible(this.checked);
                            }
                        });
                    });

                    // æ ¹æ“šé¸æ“‡é¡¯ç¤ºæˆ–éš±è—ç‰¹å®šç§‘åˆ¥çš„è¨ºæ‰€
                    document.querySelectorAll('.specialty-toggle').forEach(function(element) {
                        element.addEventListener('change', function() {
                            let specialty = this.getAttribute('data-specialty');
                            let checked = this.checked;
                            for (let district in vectorSources) {
                                vectorSources[district].getFeatures().forEach(function(feature) {
                                    if (feature.get('specialties').includes(specialty)) {
                                        feature.setStyle(new ol.style.Style({
                                            image: new ol.style.Circle({
                                                radius: 6,
                                                fill: new ol.style.Fill({
                                                    color: checked ? specialtyColors[specialty] : 'rgba(0, 0, 0, 0)'
                                                }),
                                                stroke: new ol.style.Stroke({
                                                    color: 'white',
                                                    width: 1.5
                                                })
                                            })
                                        }));
                                    }
                                });
                            }
                        });
                    });
                }
            });
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

// åŠ è¼‰æ–°åŒ—å¸‚çš„è¨ºæ‰€è³‡æ–™
loadClinicData('æ–°åŒ—å¸‚', 'æ–°åŒ—å¸‚è¨ºæ‰€_ç¶“ç·¯åº¦.csv');

// åŠ è¼‰å°åŒ—å¸‚çš„è¨ºæ‰€è³‡æ–™
loadClinicData('å°åŒ—å¸‚', 'å°åŒ—å¸‚è¨ºæ‰€_ç¶“ç·¯åº¦.csv');

// åŠ è¼‰é«˜é›„å¸‚çš„è¨ºæ‰€è³‡æ–™
loadClinicData('é«˜é›„å¸‚', 'é«˜é›„å¸‚è¨ºæ‰€_ç¶“ç·¯åº¦.csv');

// åŠ è¼‰é«˜é›„å¸‚çš„è¨ºæ‰€è³‡æ–™
loadClinicData('è‡ºå—å¸‚', 'è‡ºå—å¸‚è¨ºæ‰€_ç¶“ç·¯åº¦.csv');
// åŠ è¼‰é«˜é›„å¸‚çš„è¨ºæ‰€è³‡æ–™
loadClinicData('è‡ºä¸­å¸‚', 'è‡ºä¸­å¸‚è¨ºæ‰€_ç¶“ç·¯åº¦.csv');
// åŠ è¼‰é«˜é›„å¸‚çš„è¨ºæ‰€è³‡æ–™
loadClinicData('æ¡ƒåœ’å¸‚', 'æ¡ƒåœ’å¸‚è¨ºæ‰€_ç¶“ç·¯åº¦.csv');
//åŠ å…¥é†«å­¸ä¸­å¿ƒï¼Œæ˜Ÿå½¢æ¨™è¨˜
fetch('é†«å­¸ä¸­å¿ƒ.csv')
    .then(response => response.text())
    .then(csvText => {
        Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                results.data.forEach(row => {
                    let name = row['æ©Ÿæ§‹åç¨±'];
                    let phone = row['é›»è©±'];
                    let address = row['åœ°å€'];
                    let latitude = parseFloat(row['ç·¯åº¦']);
                    let longitude = parseFloat(row['ç¶“åº¦']);

                    let district = row['å€å'];
                    let doctor = row['Aé†«å¸«'];
                    let TCM_doctor = row['Bä¸­é†«å¸«'];
                    let dentist = row['Cç‰™é†«å¸«'];
                    let pharmacist = row['Dè—¥å¸«'];
                    let specialties = ['é†«å­¸ä¸­å¿ƒ',];

                    if (!isNaN(latitude) && !isNaN(longitude)) {
                        let coordinates = ol.proj.fromLonLat([longitude, latitude]);

                        let marker = new ol.Feature({
                            geometry: new ol.geom.Point(coordinates),
                            geometry: new ol.geom.Point(coordinates),
                            name: name,
                            phone: phone,
                            address: address,
                            doctor: doctor,
                            TCM_doctor: TCM_doctor,
                            dentist: dentist,
                            pharmacist: pharmacist,
                            specialties: specialties,

                        });
                        console.log(marker);
                        marker.setStyle(new ol.style.Style({
                            image: new ol.style.RegularShape({
                                fill: new ol.style.Fill({ color: 'rgba(255, 0, 0, 0.8)' }),
                                stroke: new ol.style.Stroke({ color: 'black', width: 1 }),
                                points: 5,
                                radius: 10,
                                radius2: 4,
                                angle: 0
                            })
                        }));

                        let vectorSource = new ol.source.Vector({
                            features: [marker]
                        });
                        let vectorLayer = new ol.layer.Vector({
                            source: vectorSource
                        });
                        map.addLayer(vectorLayer);
                    }
                });
            }
        });
    })
    .catch(error => {
        console.error('Error:', error);
    });
    



// å»ºç«‹ Overlay ä¾†é¡¯ç¤º popup
var popup = new ol.Overlay({
    element: document.getElementById('popup'),
    autoPan: false,

});


map.addOverlay(popup);

var closer = document.getElementById('popup-closer');

// Add click event listener to the closer element
closer.onclick = function() {
    console.log(document.getElementById('popup').style.display);
    document.getElementById('popup').style.display = 'none';
    infodisplay = 1;
    closer.blur();

    return false;
};


// é¡¯ç¤º popup çš„å…§å®¹
map.on('singleclick', function (evt) {
    if (isDrawing) {
        // å¦‚æœæ­£åœ¨ç¹ªåœ–ï¼Œé˜»æ­¢å½ˆå‡ºæ•ˆæœ
        return;
    }

    var feature = map.forEachFeatureAtPixel(evt.pixel, function (feature) {
        return feature;
    });

    if (feature) {
        var properties = feature.getProperties();
    
        // åˆ¤æ–·æ˜¯å¦æ˜¯è¨ºæ‰€
        if (properties.name && properties.phone && properties.address) {
            // è¨ºæ‰€çš„ popup
            var coordinates = feature.getGeometry().getCoordinates();
            popup.setPosition(coordinates);
            var specialties = feature.get('specialties');
            console.log(specialties);
            var content = '<b>' + feature.get('name') + '</b><br>' +
            'â˜ï¸é›»è©±: ' + feature.get('phone') + '<br>' ;
            content+= 'ğŸ““ç§‘åˆ¥: '+feature.get('specialties');
            // Remove the last element from the list
            //specialties.pop(); 
            /*
            specialties.forEach(function(specialty) {
                content += '' + specialty + ' ';
            });
            */
            if (feature.get('doctor') !== '0') {
                content += '<br>ğŸ’‰é†«å¸«: ' + feature.get('doctor') + 'ä½';
            }
            if (feature.get('TCM_doctor') !== '0') {
                content += '<br>ğŸŒ¿ä¸­é†«å¸«: ' + feature.get('TCM_doctor') + 'ä½';
            }
            if (feature.get('dentist') !== '0') {
                content += '<br>ğŸ¦·ç‰™é†«å¸«: ' + feature.get('dentist') + 'ä½';
            }
            if (feature.get('pharmacist') !== '0') {
                content += '<br>ğŸ’Šè—¥å¸«: ' + feature.get('pharmacist') + 'ä½';
            }
            content += '<br>åœ°å€: ' + feature.get('address');
    
        

            document.getElementById('popup-content').innerHTML = content;
            document.getElementById('popup').style.display = 'block';
            infodisplay = 0;
        } else {
            // å¦‚æœæ˜¯ GeoJSON å€åŸŸ
            var geometry = feature.getGeometry();
            coordinates = ol.extent.getCenter(geometry.getExtent());
            console.log(coordinates);
            // è¨ˆç®—è©²å€åŸŸå…§çš„è¨ºæ‰€æ•¸é‡
            var clinicCount = 0;
            for (var district in vectorSources) {
                vectorSources[district].getFeatures().forEach(function(clinicFeature) {
                    var clinicCoords = clinicFeature.getGeometry().getCoordinates();
                    if (geometry.intersectsCoordinate(clinicCoords)) {
                        clinicCount++;
                    }
                });
            }

            // é¡¯ç¤ºå€åŸŸå…§è¨ºæ‰€æ•¸é‡å’Œå…¶ä»–å€åŸŸå±¬æ€§
            var population = properties['POPULATION'] || 0;
            var maleToFemaleRatio = (properties['POPULATION_M'] !== 0) ? 
                (properties['POPULATION_M'] / properties['POPULATION_F']).toFixed(2) : 'N/A';
            var ElderIndex = properties['ElderIndex'] || "æš«ç„¡è³‡æ–™";
            console.log(ElderIndex);
            console.log(properties);
            popup.setPosition(coordinates);
    
            var content = '<b>ğŸ—ºï¸' +
                          properties['VILLAGE'] + '<br>' +
                          '<hr>'+
                          '<b>ğŸ—¿äººå£æ•¸:</b> ' + properties['POPULATION'] + '<br>' +
                          '<b>ğŸ’°æ‰€å¾—å¹³å‡æ•¸:</b> ' + Math.round(properties['2022å°ç£æ‰€å¾—data_å¹³å‡æ•¸'] / 10) + 'è¬<br>' +
                          '<b>ğŸ’°ä¸­ä½æ•¸:</b> ' + Math.round(properties['2022å°ç£æ‰€å¾—data_ä¸­ä½æ•¸'] / 10) + 'è¬<br>' +
                          '<b>ğŸ‘«ç”·å¥³æ¯”ä¾‹:</b> ' + maleToFemaleRatio + '<br>' +
                          '<b>ğŸ¥è¨ºæ‰€æ•¸é‡:</b> ' + clinicCount + ' é–“è¨ºæ‰€'+ '<br>' +
                          '<b>ä¸€é–“è¨ºæ‰€æœå‹™</b> ' + (clinicCount > 0 ? Math.round(properties['POPULATION'] / clinicCount) + 'äºº<br>' : 'ç„¡æ³•è¨ˆç®—<br>')+
                          '<b>è€åŒ–æŒ‡æ•¸</b> ' + properties['ElderIndex'] ;

            document.getElementById('popup-content').innerHTML = content;
            document.getElementById('popup').style.display = 'block';
            infodisplay = 0;
        }
    } else {
        document.getElementById('popup').style.display = 'none';
        infodisplay = 1;
    }
});

    </script>

    <script>

        // æ ¹æ“šåœ–å±¤åç¨±ä¾†æŸ¥æ‰¾åœ–å±¤
function getLayerByName(name) {
    // å–å¾—åœ°åœ–ä¸­çš„æ‰€æœ‰åœ–å±¤
    let layers = map.getLayers().getArray();

    // æ ¹æ“šåç¨±å°‹æ‰¾åŒ¹é…çš„åœ–å±¤
    for (let i = 0; i < layers.length; i++) {
        if (layers[i].get('name') === name) {
            return layers[i];  // è¿”å›æ‰¾åˆ°çš„åœ–å±¤
        }
    }
    return null;  // è‹¥æœªæ‰¾åˆ°å‰‡è¿”å› null
}


// æ ¹æ“šä¸åŒçš„æ•¸æ“šè¨­å®šæ¨£å¼
function getStyleByDataset(feature, dataset, cityData) {
    let value, ranges, colors;

    // æ ¹æ“š dataset è¨­å®šä¸åŒçš„ç´šè·ç¯„åœèˆ‡å°æ‡‰é¡è‰²
    if (dataset === 'average-income') {
        console.log('average-income');
        value = feature.get(cityData.averageIncomeField);
        ranges = cityData.averageIncomeRanges;
        colors = cityData.averageIncomeColors;
        clearColorLegend();
        showColorLegend(ranges, colors);
    } else if (dataset === 'median-income') {
        console.log('median-income');
        value = feature.get(cityData.medianIncomeField);
        ranges = cityData.medianIncomeRanges;
        colors = cityData.medianIncomeColors;
        clearColorLegend();
        showColorLegend(ranges, colors);
    } else if (dataset === 'population') {
        console.log('population');
        value = feature.get(cityData.populationField);
        ranges = cityData.populationRanges;
        colors = cityData.populationColors;
        clearColorLegend();
        showColorLegend(ranges, colors);
    } else if (dataset === 'elder-index') {
        console.log('elder-index');
        value = feature.get(cityData.elderIndexField);
        ranges = cityData.elderIndexRanges;
        colors = cityData.elderIndexColors;
        clearColorLegend();
        showColorLegend(ranges, colors);
    } else {
        value = 0;
        ranges = [0];
        colors = ['rgba(255, 255, 255, 0.1)'];
        clearColorLegend();
        showColorLegend(ranges, colors);
    }

    // æ ¹æ“šç´šè·è¨­å®šé¡è‰²
    let color = getColorForValue(value, ranges, colors);

    return new ol.style.Style({
        fill: new ol.style.Fill({
            color: color
        }),
        stroke: new ol.style.Stroke({
            color: 'black',
            width: 0.3
        })
    });
}

// æ ¹æ“š value è½åœ¨å“ªå€‹ç¯„åœä¾†é¸æ“‡å°æ‡‰çš„é¡è‰²
function getColorForValue(value, ranges, colors) {
    for (let i = 0; i < ranges.length; i++) {
        if (value < ranges[i]) {
            return colors[i];
        }
    }
    // è‹¥è¶…éæœ€å¤§ç¯„åœï¼Œä½¿ç”¨æœ€å¾Œä¸€å€‹é¡è‰²
    return colors[colors.length - 1];
}

// æ›´æ–°åœ–å±¤æ¨£å¼çš„å‡½å¼
function updateLayerStyle(dataset, incomeLayer, cityData) {
    incomeLayer.setStyle(function (feature) {
        return getStyleByDataset(feature, dataset, cityData);
    });
}

    // é¡¯ç¤ºè‰²ç¥¨çš„å‡½æ•¸
    function showColorLegend(ranges, colors) {
        const legendDiv = document.getElementById('color-legend');
        legendDiv.innerHTML = ''; // å…ˆæ¸…ç©ºä¹‹å‰çš„å…§å®¹
        ranges.forEach((range, index) => {
            const colorBox = document.createElement('div');
            colorBox.style.display = 'inline-block';
            colorBox.style.width = '30px';
            colorBox.style.height = '20px';
            colorBox.style.backgroundColor = colors[index];
            colorBox.style.marginRight = '5px';

            const label = document.createElement('span');
            label.innerText = range;

            const wrapper = document.createElement('div');
            wrapper.style.display = 'flex';
            wrapper.style.alignItems = 'center';
            wrapper.style.marginBottom = '5px';
            wrapper.appendChild(colorBox);
            wrapper.appendChild(label);

            legendDiv.appendChild(wrapper);
        });
    }

    // æ¸…é™¤è‰²ç¥¨çš„å‡½æ•¸
    function clearColorLegend() {
        const legendDiv = document.getElementById('color-legend');
        legendDiv.innerHTML = ''; // æ¸…é™¤è‰²ç¥¨å€åŸŸçš„æ‰€æœ‰å…§å®¹
    }

// è¨­ç½®äº‹ä»¶ç›£è½å™¨çš„å‡½å¼
function setupDataToggleListeners(incomeLayer, cityData) {
    document.querySelectorAll('.data-toggle').forEach(function (element) {
        element.addEventListener('change', function () {
            // å–æ¶ˆå…¶ä»–å‹¾é¸æ¡†çš„é¸æ“‡
            document.querySelectorAll('.data-toggle').forEach(function (el) {
                if (el !== element) {
                    el.checked = false;
                }
            });

            // å–å¾—ç›®å‰é¸ä¸­çš„ dataset
            let dataset = this.getAttribute('data-dataset');

            // æ›´æ–°åœ–å±¤
            updateLayerStyle(dataset, incomeLayer, cityData);

            // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½• checkbox è¢«å‹¾é¸
            let anyChecked = false;
            document.querySelectorAll('.data-toggle').forEach(function (el) {
                if (el.checked) {
                    anyChecked = true;
                }
            });

            // å¦‚æœæ²’æœ‰ä»»ä½• checkbox è¢«å‹¾é¸ï¼Œæ¸…é™¤åœ–å±¤ï¼ˆæ ¹æ“šéœ€æ±‚æ·»åŠ æ¸…é™¤é‚è¼¯ï¼‰
            if (!anyChecked) {
                // æ¸…é™¤åœ–å±¤æ¨£å¼æˆ–å…¶ä»–é‚è¼¯
            }
        });
    });
}
// å°åŒ—å¸‚è³‡æ–™é…ç½®
const taipeiData = {
    averageIncomeField: '2022å°ç£æ‰€å¾—data_å¹³å‡æ•¸',
    averageIncomeRanges: [500, 1000, 1500, 2000],
    averageIncomeColors: [
        'rgba(255, 235, 190, 0.6)',
        'rgba(255, 204, 128, 0.6)',
        'rgba(255, 153, 85, 0.6)',
        'rgba(255, 77, 77, 0.6)'
    ],
    medianIncomeField: '2022å°ç£æ‰€å¾—data_ä¸­ä½æ•¸',
    medianIncomeRanges: [300, 600, 900, 1200],
    medianIncomeColors: [
        'rgba(230, 245, 208, 0.6)',
        'rgba(170, 220, 130, 0.6)',
        'rgba(110, 200, 80, 0.6)',
        'rgba(50, 150, 30, 0.6)'
    ],
    populationField: 'POPULATION',
    populationRanges: [1000, 3000, 5000, 10000],
    populationColors: [
        'rgba(190, 235, 255, 0.6)',
        'rgba(128, 204, 255, 0.6)',
        'rgba(85, 153, 255, 0.6)',
        'rgba(77, 77, 255, 0.6)'
    ],
    elderIndexField: 'ElderIndex',
    elderIndexRanges: [0.1, 0.3, 0.5, 0.8],
    elderIndexColors: [
        'rgba(190, 235, 255, 0.6)',
        'rgba(128, 204, 255, 0.6)',
        'rgba(85, 153, 255, 0.6)',
        'rgba(77, 77, 255, 0.6)'
    ]
};

// æ–°åŒ—å¸‚è³‡æ–™é…ç½®
const newTaipeiData = {
    averageIncomeField: '2022å°ç£æ‰€å¾—data_å¹³å‡æ•¸',
    averageIncomeRanges: [400, 800, 1200, 1600],
    averageIncomeColors: [
        'rgba(255, 240, 180, 0.6)',
        'rgba(255, 210, 120, 0.6)',
        'rgba(255, 160, 90, 0.6)',
        'rgba(255, 90, 60, 0.6)'
    ],
    medianIncomeField: '2022å°ç£æ‰€å¾—data_ä¸­ä½æ•¸',
    medianIncomeRanges: [250, 500, 750, 1000],
    medianIncomeColors: [
        'rgba(230, 250, 200, 0.6)',
        'rgba(180, 220, 140, 0.6)',
        'rgba(120, 180, 90, 0.6)',
        'rgba(60, 140, 50, 0.6)'
    ],
    populationField: 'POPULATION',
    populationRanges: [500, 2000, 4000, 8000],
    populationColors: [
    'rgba(190, 235, 255, 0.6)',
    'rgba(128, 204, 255, 0.6)',
    'rgba(85, 153, 255, 0.6)',
    'rgba(77, 77, 255, 0.6)'
    ]
};

const taichungData = {
    averageIncomeField: '2022å°ç£æ‰€å¾—data_å¹³å‡æ•¸',
    averageIncomeRanges: [400, 900, 1300, 1700],
    averageIncomeColors: [
        'rgba(250, 240, 200, 0.6)',
        'rgba(250, 200, 150, 0.6)',
        'rgba(250, 150, 100, 0.6)',
        'rgba(250, 100, 50, 0.6)'
    ],
    medianIncomeField: '2022å°ç£æ‰€å¾—data_ä¸­ä½æ•¸',
    medianIncomeRanges: [200, 500, 800, 1100],
    medianIncomeColors: [
        'rgba(230, 250, 210, 0.6)',
        'rgba(180, 240, 150, 0.6)',
        'rgba(130, 190, 100, 0.6)',
        'rgba(80, 130, 50, 0.6)'
    ],
    populationField: 'POPULATION',
    populationRanges: [1500, 3500, 5500, 9000],
    populationColors: [
        'rgba(210, 240, 255, 0.6)',
        'rgba(150, 200, 255, 0.6)',
        'rgba(100, 150, 255, 0.6)',
        'rgba(50, 100, 255, 0.6)'
    ]
};
const tainanData = {
    averageIncomeField: '2022å°ç£æ‰€å¾—data_å¹³å‡æ•¸',
    averageIncomeRanges: [300, 800, 1200, 1600],
    averageIncomeColors: [
        'rgba(255, 235, 200, 0.6)',
        'rgba(255, 195, 150, 0.6)',
        'rgba(255, 145, 100, 0.6)',
        'rgba(255, 95, 50, 0.6)'
    ],
    medianIncomeField: '2022å°ç£æ‰€å¾—data_ä¸­ä½æ•¸',
    medianIncomeRanges: [250, 550, 850, 1150],
    medianIncomeColors: [
        'rgba(235, 245, 215, 0.6)',
        'rgba(185, 225, 165, 0.6)',
        'rgba(135, 175, 115, 0.6)',
        'rgba(85, 125, 65, 0.6)'
    ],
    populationField: 'äººå£æ•¸_äººå£æ•¸',
    populationRanges: [1000, 3000, 5000, 7000],
    populationColors: [
        'rgba(200, 235, 255, 0.6)',
        'rgba(140, 195, 255, 0.6)',
        'rgba(90, 145, 255, 0.6)',
        'rgba(40, 95, 255, 0.6)'
    ]
};
const kaohsiungData = {
    averageIncomeField: '2022å°ç£æ‰€å¾—data_å¹³å‡æ•¸',
    averageIncomeRanges: [450, 950, 1400, 1800],
    averageIncomeColors: [
        'rgba(255, 245, 190, 0.6)',
        'rgba(255, 215, 130, 0.6)',
        'rgba(255, 175, 80, 0.6)',
        'rgba(255, 135, 40, 0.6)'
    ],
    medianIncomeField: '2022å°ç£æ‰€å¾—data_ä¸­ä½æ•¸',
    medianIncomeRanges: [300, 600, 900, 1200],
    medianIncomeColors: [
        'rgba(240, 255, 215, 0.6)',
        'rgba(190, 235, 165, 0.6)',
        'rgba(140, 195, 115, 0.6)',
        'rgba(90, 145, 65, 0.6)'
    ],
    populationField: 'POPULATION',
    populationRanges: [1200, 2500, 4000, 6500],
    populationColors: [
        'rgba(220, 245, 255, 0.6)',
        'rgba(160, 205, 255, 0.6)',
        'rgba(110, 155, 255, 0.6)',
        'rgba(60, 105, 255, 0.6)'
    ]
};
const taoyuanData = {
    averageIncomeField: '2022å°ç£æ‰€å¾—data_å¹³å‡æ•¸',
    averageIncomeRanges: [500, 1000, 1500, 2000],
    averageIncomeColors: [
        'rgba(255, 240, 190, 0.6)',
        'rgba(255, 210, 140, 0.6)',
        'rgba(255, 170, 90, 0.6)',
        'rgba(255, 120, 40, 0.6)'
    ],
    medianIncomeField: '2022å°ç£æ‰€å¾—data_ä¸­ä½æ•¸',
    medianIncomeRanges: [300, 700, 1100, 1400],
    medianIncomeColors: [
        'rgba(235, 255, 210, 0.6)',
        'rgba(185, 235, 160, 0.6)',
        'rgba(135, 195, 110, 0.6)',
        'rgba(85, 145, 60, 0.6)'
    ],
    populationField: 'POPULATION',
    populationRanges: [1500, 4000, 7000, 10000],
    populationColors: [
        'rgba(210, 240, 255, 0.6)',
        'rgba(150, 205, 255, 0.6)',
        'rgba(100, 155, 255, 0.6)',
        'rgba(50, 105, 255, 0.6)'
    ]
};


const cityDataMap = {
    'Taipei': taipeiData,
    'New Taipei': newTaipeiData,
    'Taichung': taichungData,
    'Tainan': tainanData,
    'Kaohsiung': kaohsiungData,
    'Taoyuan': taoyuanData
};



// ä½¿ç”¨å‡½å¼è¨­ç½®æ¨£å¼å’Œç›£è½å™¨
// å‘¼å«å°åŒ—å¸‚çš„åœ–å±¤
let taipeiLayer = getLayerByName('Taipei');
// ä¾‹å¦‚ï¼šæŸ¥æ‰¾åç‚º "Taipei" çš„åœ–å±¤
if (taipeiLayer) {
    console.log('æ‰¾åˆ°åœ–å±¤: ', taipeiLayer);
} else {
    console.log('æœªæ‰¾åˆ°åœ–å±¤');
}
if (taipeiLayer) {
    // æ›´æ–°å°åŒ—å¸‚åœ–å±¤çš„æ¨£å¼
    updateLayerStyle('average-income', taipeiLayer, taipeiData);
    setupDataToggleListeners(taipeiLayer, taipeiData);
}
let newTaipeiLayer = getLayerByName('New Taipei');
// ä¾‹å¦‚ï¼šæŸ¥æ‰¾åç‚º "New Taipei" çš„åœ–å±¤
if (newTaipeiLayer) {
    console.log('æ‰¾åˆ°åœ–å±¤: ', newTaipeiLayer);
} else {
    console.log('æœªæ‰¾åˆ°åœ–å±¤');
}
if (newTaipeiLayer) {
    // æ›´æ–°å°åŒ—å¸‚åœ–å±¤çš„æ¨£å¼
    updateLayerStyle('average-income', newTaipeiLayer, newTaipeiData);
    setupDataToggleListeners(newTaipeiLayer, newTaipeiData);
}

let kaohsiungLayer = getLayerByName('Kaohsiung');
// ä¾‹å¦‚ï¼šæŸ¥æ‰¾åç‚º "New Taipei" çš„åœ–å±¤
if (kaohsiungLayer) {
    console.log('æ‰¾åˆ°åœ–å±¤: ', kaohsiungLayer);
} else {
    console.log('æœªæ‰¾åˆ°åœ–å±¤');
}
if (kaohsiungLayer) {
    // æ›´æ–°å°åŒ—å¸‚åœ–å±¤çš„æ¨£å¼
    updateLayerStyle('average-income', kaohsiungLayer, kaohsiungData);
    setupDataToggleListeners(kaohsiungLayer, kaohsiungData);
}

let tainanLayer = getLayerByName('Tainan');
// ä¾‹å¦‚ï¼šæŸ¥æ‰¾åç‚º "New Taipei" çš„åœ–å±¤
if (tainanLayer) {
    console.log('æ‰¾åˆ°åœ–å±¤: ', tainanLayer);
} else {
    console.log('æœªæ‰¾åˆ°åœ–å±¤');
}
if (tainanLayer) {
    // æ›´æ–°å°åŒ—å¸‚åœ–å±¤çš„æ¨£å¼
    updateLayerStyle('average-income', tainanLayer, tainanData);
    setupDataToggleListeners(tainanLayer, tainanData);
}

let taichungLayer = getLayerByName('Taichung');
// ä¾‹å¦‚ï¼šæŸ¥æ‰¾åç‚º "Taichung" çš„åœ–å±¤
if (taichungLayer) {
    console.log('æ‰¾åˆ°åœ–å±¤: ', taichungLayer);
} else {
    console.log('æœªæ‰¾åˆ°åœ–å±¤');
}
if (taichungLayer) {
    // æ›´æ–°å°ä¸­å¸‚åœ–å±¤çš„æ¨£å¼
    updateLayerStyle('average-income', taichungLayer, taichungData);
    setupDataToggleListeners(taichungLayer, taichungData);
}

let taoyuanLayer = getLayerByName('Taoyuan');
// ä¾‹å¦‚ï¼šæŸ¥æ‰¾åç‚º "Taoyuan" çš„åœ–å±¤
if (taoyuanLayer) {
    console.log('æ‰¾åˆ°åœ–å±¤: ', taoyuanLayer);
} else {
    console.log('æœªæ‰¾åˆ°åœ–å±¤');
}
if (taoyuanLayer) {
    // æ›´æ–°æ¡ƒåœ’å¸‚åœ–å±¤çš„æ¨£å¼
    updateLayerStyle('average-income', taoyuanLayer, taoyuanData);
    setupDataToggleListeners(taoyuanLayer, taoyuanData);
}
</script>

    <script>
        // å–å¾— info çš„ DOM å…ƒç´ 
    const info = document.getElementById('info');
    var infodisplay = 1;
    // ç•¶æ»‘é¼ ç§»å‹•æ™‚è™•ç† hover äº‹ä»¶
    map.on('pointermove', function(event) {
        if (infodisplay === 0) {
            return;
        }
        // å–å¾—æ»‘é¼ ä½ç½®å°æ‡‰çš„ç‰¹å¾µ
        map.forEachFeatureAtPixel(event.pixel, function(feature) {
            const districtName = feature.get('VILLAGE');  // å‡è¨­ GeoJSON å±¬æ€§åŒ…å« 'name' å­—æ®µè¡¨ç¤ºé‡Œåç¨±
            
            if (districtName) {
                // é¡¯ç¤ºé‡Œåç¨±
                info.style.display = 'block';
                info.innerHTML = `${districtName}`;
                
                // å°‡ info ä½ç½®è¨­ç½®ç‚ºæ»‘é¼ ä½ç½®
                info.style.left = `${event.pixel[0] + 1}px`;
                info.style.top = `${event.pixel[1] + 1}px`;
            }
        }, {
            hitTolerance: 0  // å¢åŠ é»æ“Šç¯„åœä»¥æé«˜ç”¨æˆ¶é«”é©—
        });
    });
    
    // ç•¶æ»‘é¼ é›¢é–‹åœ°åœ–ç¯„åœæ™‚ï¼Œéš±è— info
    map.getViewport().addEventListener('mouseout', function() {
        info.style.display = 'none';
    });
    
// è¨ºæ‰€æœå°‹åŠŸèƒ½
var clinicList = document.getElementById('clinic-list');
var clinicSearch = document.getElementById('clinic-search');
var addedClinics = new Set(); // ç”¨ä¾†è¿½è¹¤å·²æ·»åŠ çš„è¨ºæ‰€ï¼Œé¿å…é‡è¤‡

    // å®šç¾©è®€å–CSVæª”æ¡ˆä¸¦å°‡è¨ºæ‰€è³‡æ–™åŠ å…¥é¸å–®çš„å‡½æ•¸
    function loadClinicsFromCSV(csvFiles) {
        csvFiles.forEach(file => {
            fetch(file)
                .then(response => response.text())
                .then(csvText => {
                    console.log('CSV data loaded from', file); // Debug: ç¢ºèªCSVæª”æ¡ˆå·²åŠ è¼‰
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            console.log('Parsed CSV data from', file, results.data); // Debug: é¡¯ç¤ºè§£æå¾Œçš„æ•¸æ“š
                            results.data.forEach(row => {
                                let name = row['æ©Ÿæ§‹åç¨±'];
                                let district = row['å€å'];
                                let latitude = parseFloat(row['ç·¯åº¦']);
                                let longitude = parseFloat(row['ç¶“åº¦']);

                                if (!isNaN(latitude) && !isNaN(longitude) && !addedClinics.has(name)) {
                                    let option = document.createElement('option');
                                    option.value = name; // å°‡è¨ºæ‰€åç¨±è¨­ç‚ºé¸é …çš„å€¼
                                    option.text = name + ' (' + district + ')';
                                    option.setAttribute('data-lat', latitude);   // å­˜å„²ç·¯åº¦
                                    option.setAttribute('data-lon', longitude);  // å­˜å„²ç¶“åº¦
                                    clinicList.appendChild(option);
                                    addedClinics.add(name); // å°‡è¨ºæ‰€åç¨±åŠ å…¥è¿½è¹¤é›†åˆä¸­ï¼Œé¿å…é‡è¤‡
                                    // console.log('Added option:', option.text); // Debug: ç¢ºèªé¸é …è¢«æ·»åŠ 
                                }
                            });
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading CSV from', file, error); // Debug: åŠ è¼‰CSVå‡ºéŒ¯
                });
        });
    }

    // è¨ºæ‰€æœå°‹åŠŸèƒ½ (å¯ä»¥è‡ªå®šç¾©æœå°‹é‚è¼¯)
    clinicSearch.addEventListener('input', function() {
        let keyword = clinicSearch.value.trim();
        console.log('Search keyword:', keyword); // Debug: é¡¯ç¤ºä½¿ç”¨è€…è¼¸å…¥çš„æœç´¢é—œéµå­—
    });

    // è®€å–å¤šå€‹CSVæª”æ¡ˆ
    const csvFiles = [
        'æ–°åŒ—å¸‚è¨ºæ‰€_ç¶“ç·¯åº¦.csv',
        'å°åŒ—å¸‚è¨ºæ‰€_ç¶“ç·¯åº¦.csv', 
        'æ¡ƒåœ’å¸‚è¨ºæ‰€_ç¶“ç·¯åº¦.csv',
        'è‡ºå—å¸‚è¨ºæ‰€_ç¶“ç·¯åº¦.csv',
        'è‡ºä¸­å¸‚è¨ºæ‰€_ç¶“ç·¯åº¦.csv',
        'é«˜é›„å¸‚è¨ºæ‰€_ç¶“ç·¯åº¦.csv'
    ];
loadClinicsFromCSV(csvFiles);

// ç›£è½è¼¸å…¥æ¡†çš„ change äº‹ä»¶
clinicSearch.addEventListener('change', function() {
    let selectedClinicName = clinicSearch.value; // ç²å–è¼¸å…¥æ¡†çš„å€¼
    let options = clinicList.options;

    for (let i = 0; i < options.length; i++) {
        let option = options[i];
        if (option.value === selectedClinicName) {
            // ç²å–å°æ‡‰çš„ç¶“ç·¯åº¦
            let latitude = parseFloat(option.getAttribute('data-lat'));
            let longitude = parseFloat(option.getAttribute('data-lon'));

            console.log('Selected clinic:', selectedClinicName); // Debug: é¡¯ç¤ºé¸æ“‡çš„è¨ºæ‰€åç¨±
            console.log('Latitude:', latitude, 'Longitude:', longitude); // Debug: é¡¯ç¤ºè¨ºæ‰€çš„ç¶“ç·¯åº¦

            if (!isNaN(latitude) && !isNaN(longitude)) {
                let coordinates = ol.proj.fromLonLat([longitude, latitude]);  // å°‡ç¶“ç·¯åº¦è½‰æ›ç‚ºåœ°åœ–åæ¨™
                console.log('Map coordinates:', coordinates); // Debug: é¡¯ç¤ºè½‰æ›å¾Œçš„åœ°åœ–åæ¨™

                map.getView().animate({
                    center: coordinates,
                    zoom: 16
                });
                console.log('Map animation triggered.'); // Debug: ç¢ºèªåœ°åœ–å‹•ç•«è¢«è§¸ç™¼

                // åœ¨é€™è£¡æ·»åŠ  popup çš„é¡¯ç¤ºé‚è¼¯
                // å‡è¨­ä½ æœ‰ä¸€å€‹ç‰¹å¾µå°æ‡‰æ–¼é€™å€‹é¸é …
                let feature = getFeatureByName(selectedClinicName); // é€™æ˜¯ä¸€å€‹å‡è¨­çš„å‡½æ•¸ï¼Œä½ éœ€è¦æ ¹æ“šå¯¦éš›æƒ…æ³ç²å–å°æ‡‰çš„ç‰¹å¾µ

                if (feature) {
                    var popupCoordinates = feature.getGeometry().getCoordinates(); // ç²å– popup çš„ä½ç½®
                    popup.setPosition(popupCoordinates); // è¨­ç½® popup ä½ç½®

                    var specialties = feature.get('specialties').split(',').map(function(specialty) {
                        return specialty.trim();
                    });
                    console.log(specialties);

                    var content = '<b>' + feature.get('name') + '</b><br>' +
                        'â˜ï¸é›»è©±: ' + feature.get('phone') + '<br>' +
                        'ğŸ““ç§‘åˆ¥: ';

                    // Remove the last element from the list
                    specialties.pop();
                    specialties.forEach(function(specialty) {
                        content += '' + specialty + ' ';
                    });

                    if (feature.get('doctor') !== '0') {
                        content += '<br>ğŸ’‰é†«å¸«: ' + feature.get('doctor') + 'ä½';
                    }
                    if (feature.get('TCM_doctor') !== '0') {
                        content += '<br>ğŸŒ¿ä¸­é†«å¸«: ' + feature.get('TCM_doctor') + 'ä½';
                    }
                    if (feature.get('dentist') !== '0') {
                        content += '<br>ğŸ¦·ç‰™é†«å¸«: ' + feature.get('dentist') + 'ä½';
                    }
                    if (feature.get('pharmacist') !== '0') {
                        content += '<br>ğŸ’Šè—¥å¸«: ' + feature.get('pharmacist') + 'ä½';
                    }
                    content += '<br>åœ°å€: ' + feature.get('address');

                    // æ›´æ–° popup çš„å…§å®¹
                    document.getElementById('popup-content').innerHTML = content;
                    document.getElementById('popup').style.display = 'block'; // é¡¯ç¤º popup
                }
            } else {
                console.error('Invalid coordinates for the selected clinic.'); // Debug: ç¶“ç·¯åº¦ç„¡æ•ˆçš„éŒ¯èª¤è¨Šæ¯
            }
            break; // æ‰¾åˆ°å°æ‡‰é¸é …å¾Œå¯è·³å‡ºå¾ªç’°
        }
    }
});

// å‡è¨­çš„å‡½æ•¸ï¼Œæ ¹æ“šè¨ºæ‰€åç¨±ç²å–ç›¸æ‡‰çš„ feature
function getFeatureByName(name) {
    let foundFeature = null;
    map.getLayers().forEach(function(layer) {
        if (layer instanceof ol.layer.Vector) {
            layer.getSource().getFeatures().forEach(function(feature) {
                if (feature.get('name') === name) {
                    foundFeature = feature;
                }
            });
        }
    });
    return foundFeature;
}




    </script>


</body>
</html>
